# -*- coding: utf-8 -*-
"""DataPreparationLLMs-4.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/19eRuBghCX8k98i7mBGSfNr1DJylveNu5

---

### **Install** **Required** **Package**   **And** **Login To** **Huggingface**

---



---
"""

!pip install -q datasets
!huggingface-cli login

"""---

### **Data transformation For train**

---
In this script, we transform a dataset loaded from a local JSON file named 'OphtalmologyQCM.json' using a custom transformation function. The dataset contains conversation data structured with '### Human' and '### Assistant' columns. Our transformation process involves creating a new text format by combining the content from these two columns. Each conversation is encapsulated within '<s>' and '</s>' tags, with '### Human' content preceding '### Assistant' content, separated by a specific template '[INST] ... [/INST]'. This transformation ensures that the data is formatted appropriately for further analysis or processing.

Steps:
1. Load the dataset from a local JSON file named 'OphtalmologyQCM.json'.
2. Define a transformation function, 'transform_conversation', that:
   - Extracts the content of the '### Human' and '### Assistant' columns from each example.
   - Combines the content into a new text format using the specified template: '<s>[INST] {human_text} [/INST] {assistant_text} </s>'.
3. Apply the transformation to the dataset using the 'map' method, creating a new 'text' column with the formatted text.
[link text](https://)
"""

from datasets import load_dataset

# Load the OphtalmologyQCM.json ataset
dataset = load_dataset('json', data_files='OphtalmologyQCM.json')

def transform_conversation(example):
    human_text = example['### Human']
    assistant_text = example['### Assistant']

    # Apply the new template
    transformed_example = f'<s>[INST] {human_text} [/INST] {assistant_text} </s>'

    return {'text': transformed_example}

# Apply the transformation
transformed_dataset = dataset.map(transform_conversation)

"""---

### **Pushing the first transformed data  for train to hub**

---
"""

transformed_dataset.push_to_hub("OphtalmologyQCM")

"""---

### **Load the transformed data for trining from hagging Face**

---

---


'''
In this script, we load our first transformed dataset from Hugging Face and perform a new transformation on the data by removing two specific columns: '### Human' and '### Assistant'. The transformation involves creating a new text format combining the content from these two columns. The transformed data will then be ready for further processing or analysis.

Steps:
1. Load the dataset from Hugging Face.
2. Define a transformation function that:
   - Extracts and removes the '### Human' and '### Assistant' columns.
   - Creates a new text format incorporating both columns.
3. Apply the transformation to the dataset, ensuring the specified columns are removed.
4. Push the dataset to the hub.
'''
"""

from datasets import load_dataset

# Load the OphtalmologyQCM dataset
dataset = load_dataset("abirT/OphtalmologyQCM")


def transform_conversation(example):
    human_text = example.pop('### Human')
    assistant_text = example.pop('### Assistant')

    # Apply the new template
    transformed_example = f'<s>[INST] {human_text} [/INST] {assistant_text} </s>'

    return {'text': transformed_example}

# Apply the transformation
transformed_dataset = dataset.map(transform_conversation, remove_columns=['### Human', '### Assistant'])

# Check the result
print(transformed_dataset)

"""---

### **Pushing the final transformed data for train to hub**

---

---


"""

transformed_dataset.push_to_hub("OphtalmologyQCMFinal")

"""---

### **Data transformation For validation**

---
In this script, we transform a dataset loaded from a local JSON file named 'OphtalmologyQCM.json' using a custom transformation function. The dataset contains conversation data structured with '### Human' and '### Assistant' columns. Our transformation process involves creating a new text format by combining the content from these two columns. Each conversation is encapsulated within '<s>' and '</s>' tags, with '### Human' content preceding '### Assistant' content, separated by a specific template '[INST] ... [/INST]'. This transformation ensures that the data is formatted appropriately for further analysis or processing.

Steps:
1. Load the dataset from a local JSON file named 'OphtalmologyQCMEvalute.json'.
2. Define a transformation function, 'transform_conversation', that:
   - Extracts the content of the '### Human' and '### Assistant' columns from each example.
   - Combines the content into a new text format using the specified template: '<s>[INST] {human_text} [/INST] {assistant_text} </s>'.
3. Apply the transformation to the dataset using the 'map' method, creating a new 'text' column with the formatted text.
[link text](https://)
"""

from datasets import load_dataset

# Load the OphtalmologyQCMEvalute dataset
dataset = load_dataset('json', data_files='OphtalmologyQCMEvalute.json')

def transform_conversation(example):
    human_text = example['### Human']
    assistant_text = example['### Assistant']

    # Apply the new template
    transformed_example = f'<s>[INST] {human_text} [/INST] {assistant_text} </s>'

    return {'text': transformed_example}

# Apply the transformation
transformed_dataset = dataset.map(transform_conversation)

"""---

### **Pushing the first transformed data for validation to hub**

---



---
"""

transformed_dataset.push_to_hub("OphtalmologyQCMEval")

"""---

### **Load the transformed data for validation from hagging Face**

---
'''
In this script, we load our first transformed dataset from Hugging Face and perform a new transformation on the data by removing two specific columns: '### Human' and '### Assistant'. The transformation involves creating a new text format combining the content from these two columns. The transformed data will then be ready for further processing or analysis.

Steps:
1. Load the dataset from Hugging Face.
2. Define a transformation function that:
   - Extracts and removes the '### Human' and '### Assistant' columns.
   - Creates a new text format incorporating both columns.
3. Apply the transformation to the dataset, ensuring the specified columns are removed.
4. Push the dataset to the hub.
'''
"""

from datasets import load_dataset

# Load the OphtalmologyQCMEval  dataset
dataset = load_dataset("abirT/OphtalmologyQCMEval")


def transform_conversation(example):
    human_text = example.pop('### Human')
    assistant_text = example.pop('### Assistant')

    # Apply the new template
    transformed_example = f'<s>[INST] {human_text} [/INST] {assistant_text} </s>'

    return {'text': transformed_example}

# Apply the transformation
transformed_dataset = dataset.map(transform_conversation, remove_columns=['### Human', '### Assistant'])

# Check the result
print(transformed_dataset)

"""---

### **Pushing the final transformed data for validation to hub**

---



---
"""

transformed_dataset.push_to_hub("OphtalmologyQCMEvalFinal")

"""

---

 ### **Combined Ophthalmology Datasets**

---

First step , we integrated two datasets related to ophthalmology: the EYE QA PLUS dataset and the OphtalmologyQCM dataset. Initially, both datasets were loaded using the load_dataset function from the Hugging Face library. We then applied transformation functions to standardize the format of each dataset, ensuring consistency for seamless integration.

For the EYE QA PLUS dataset, a transformation function named transform_eye_qa_plus was created. This function extracted the question and response from each example and formatted them within HTML-like tags, facilitating clarity and organization.

Similarly, for the OphtalmologyQCM dataset, another transformation function named transform_dataset was implemented. This function extracted the human and assistant text segments from each example and combined them into a coherent structure suitable for analysis.

Once the transformations were applied to both datasets, they were concatenated into a unified dataset using the concatenate_datasets function. This step ensured that the integrated dataset contained all relevant information from both sources.

Subsequently, redundant columns such as 'input', 'output', and 'instruction' were removed from the combined dataset to streamline its structure and enhance usability.

Finally, the processed dataset was saved to disk and uploaded to the Hugging Face Hub.
"""

from datasets import load_dataset, DatasetDict, concatenate_datasets

# Load the EYE QA PLUS dataset
eye_qa_plus = load_dataset("QIAIUNCC/EYE-QA-PLUS")

# Load the OphtalmologyQCM  dataset
dataset = load_dataset("abirT/OphtalmologyQCM")

# Function to transform the EYE QA PLUS dataset
def transform_eye_qa_plus(example):
    question = example['input']
    response = example['output']
    text = f"<s>[INST]  {question} [/INST] {response} </s>"
    return {'### Human': f"{question}", '### Assistant': f"{response}", 'text': text}

# Apply the transformation to the EYE QA PLUS dataset
transformed_eye_qa_plus = eye_qa_plus['train'].map(transform_eye_qa_plus)

# Function to transform  dataset
def transform_dataset(example):
    return {'### Human': example['### Human'], '### Assistant': example['### Assistant'], 'text': f"{example['### Human']} {example['### Assistant']}"}

# Apply the transformation to  dataset
transformed_dataset = dataset['train'].map(transform_dataset)

# Concatenate the datasets
concatenated_dataset = concatenate_datasets([transformed_dataset, transformed_eye_qa_plus])

# Create a DatasetDict
combined_dataset = DatasetDict({
    'dataset': concatenated_dataset
})

# Remove the 'input', 'output', and 'instruction' columns
combined_dataset['dataset'] = combined_dataset['dataset'].remove_columns(['input', 'output', 'instruction'])

# Save the combined dataset to disk
combined_dataset.save_to_disk('combined_ophthalmology_dataset')

# Push the combined dataset to the Hugging Face Hub
combined_dataset.push_to_hub('combined_ophthalmology_dataset')

print(combined_dataset)

"""

---

### **Formatting Dataset**

---



---



Here, we reload the previously combined dataset from the saved location using the load_from_disk function. Subsequently, a function named format_text is defined to format the text column appropriately. This function extracts the human and assistant text segments from each example and structures them within HTML-like tags for clarity.

After defining the formatting function, it is applied to the dataset using the map method. This step ensures that the text column in the dataset is formatted according to the desired structure.

Once the formatting is applied, the formatted dataset is saved to disk using the save_to_disk method. Finally, the formatted dataset is pushed to the Hugging Face Hub."""

from datasets import load_from_disk

# Reload the combined dataset
combined_dataset = load_from_disk('combined_ophthalmology_dataset')

# Function to format the text column
def format_text(example):
    human_text = example['### Human']
    assistant_text = example['### Assistant']
    formatted_text = f"<s>[INST]{human_text}[/INST] {assistant_text}</s>"
    return {'text': formatted_text}

# Apply the formatting to the dataset
formatted_dataset = combined_dataset['dataset'].map(format_text)

# Save the formatted dataset to disk
formatted_dataset.save_to_disk('ophthalmology_dataset')

# Push the combined dataset to the Hugging Face Hub
formatted_dataset.push_to_hub('ophthalmology_dataset')

from datasets import list_datasets

# Search for datasets related to ophthalmology
ophthalmology_datasets = [dataset_id for dataset_id in list_datasets() if "ophthalmology" in dataset_id.lower()]

# Print the list of ophthalmology-related datasets
print(ophthalmology_datasets)

from datasets import list_datasets

# Search for datasets related to eye diseases
eye_disease_datasets = [dataset_id for dataset_id in list_datasets() if "eye_disease" in dataset_id.lower()]

# Print the list of eye disease-related datasets
print(eye_disease_datasets)

"""

---

### Data Generation Script

---



---

"""

!pip install pandas

"""

---

### Model Evalution Generator Script

---



---

"""

import csv
import datetime
import random
import pandas as pd
from collections import defaultdict
from IPython.display import display, HTML
# Define the columns for the CSV file
columns = ["Timestamp",
           "Question Type",
           "Question",
           "Corrected Response",
           "Evaluation",
           "Response Time (s)"]


# Define the types of questions and possible responses
question_types = [
    "Ocular Anatomy QCM",
    "Ocular Pathology QCM",
    "General Ophthalmology QCM",
    "Clinical Cases QCM"
]

model_name = "abirT/Llama-2-7B-finetuning-ophtalmology"
responses = ["complet", "incomplet", "incorrect"]
model_response=" "



# questions and corrected responses
sample_questions = {
    "Ocular Anatomy QCM": [
        {
            "question": "La rétine ? a. Est un tissu neurosensoriel. b. Est composée de 5 couches. c. Au centre se trouve la macula comportant une forte concentration en bâtonnets et responsable de l’acuité visuelle maximale. d. Constituée de photorécepteurs de sorte que les cônes périphériques assurent la vision diurne et les cônes centraux la vision nocturne. e. Toutes les réponses sont fausses.",
            "corrected_response": "a. Est un tissu neurosensoriel."
        },
        {
            "question": "Le cristallin ? a. Est une lentille biconcave richement vascularisée. b. Il est responsable de l'accommodation. c. Sa caractéristique principale est la transparence. d. Est localisé entre l'iris et la chambre postérieure en avant et la rétine en arrière. e. Est suspendu au corps ciliaire par la zonule de ZINN.",
            "corrected_response": "a. Est une lentille biconcave richement vascularisée. d. Est localisé entre l'iris et la chambre postérieure en avant et la rétine en arrière."
        },
          {
            "question": "Les muscles oculomoteurs ? a. Assurent la motilité du globe oculaire. b. Le III innerve le droit externe. c. Le VI innerve le sphincter irien. d. Le III innerve l'oblique supérieure. e. Le IV innerve l'oblique inférieure",
            "corrected_response": "a. Assurent la motilité du globe oculaire."
        },
        {
            "question": "La longueur axiale ? a. Est la distance entre le sommet de la cornée et la rétine. b. La distance entre la cornée et le cristallin. c. Mesure entre 22 et 24 mm. d. Plus élevée chez le myope. e. Plus courte en cas d'astigmatisme.",
            "corrected_response": "a. Est la distance entre le sommet de la cornée et la rétine. c. Mesure entre 22 et 24 mm. d. Plus élevée chez le myope."
            },
         {
            "question": "La cornée ? a. Assure 1 / 3 du pouvoir réfractif du globe oculaire. b. Le test à la fluorescéine permet de rechercher une atteinte de l’endothélium cornéen. c. Le port de lentilles de contact est le principal facteur de risque des infections de la cornée. d. Les collyres corticoïdes retardent la cicatrisation de l'épithélium cornéen. e. Dans les brûlures chimiques, les acides pénètrent très rapidement dans le stroma cornéen.",
            "corrected_response": "c. Le port de lentilles de contact est le principal facteur de risque des infections de la cornée. d. Les collyres corticoïdes retardent la cicatrisation de l'épithélium cornéen." },
         {
            "question": "La microscopie spéculaire ? a. Elle permet le calcul du rayon de courbure de la cornée. b. Elle permet le calcul de la longueur axiale. c. Elle permet le calcul du comptage des cellules endothéliales cornéennes. d. Elle permet l'exploration du segment postérieur de l'œil. e. Elle permet une coupe presque histologique de la rétine.",
            "corrected_response": "c. Elle permet le calcul du comptage des cellules endothéliales cornéennes."
             },
         {
            "question": "Concernant les voies lacrymales ? a. L'imperméabilité des voies lacrymales peut donner un larmoiement. b. Une sténose des voies lacrymales nécessite parfois une intervention chirurgicale. c. L'imperméabilité des voies lacrymales se diagnostique par un test au bleu de méthylène. d. L'imperméabilité des voies lacrymales peut donner une kératite. e. Un larmoiement chronique impose un bilan ophtalmologique.",
            "corrected_response": "a. L'imperméabilité des voies lacrymales peut donner un larmoiement. b. Une sténose des voies lacrymales nécessite parfois une intervention chirurgicale. d. L'imperméabilité des voies lacrymales peut donner une kératite. e. Un larmoiement chronique impose un bilan ophtalmologique." }
             ,
           {
            "question": "Question: Diameter of the macula lutea is: Options: A. 1.5 mm B. 3.5 mm C. 4.5 mm D. 5.5 mm",
            "corrected_response": "OPTION D IS CORRECT."
             },
         {
            "question": "Question: Corneal endothelium is embryologically derived from Options: A. Neural crest B. Ectoderm C. Mesoderm D. Endoderm",
            "corrected_response": "OPTION A IS CORRECT."
             },
        {
            "question":" Question: Lamina cribrosa is not present in Options: A. Morning glory syndrome B. Nanophthalmia C. Coloboma of retina D. Optic nerve agenesis",
            "corrected_response": "Morning glory syndrome is a mesodermal defect in which there is peripapillary defect along with absence of lamina cribrosa. OPTION A IS CORRECT."
        }




   ],
    "Ocular Pathology QCM": [


             {
                "question": "L'héméralopie est liée à ? a. La cataracte. b. Un diabète. c. La rétinite pigmentaire. d. Un décollement de rétine. e. La DMLA.",
                "corrected_response": "c. La rétinite pigmentaire." },
            {
                "question": "Une hémorragie intravitréenne peut être due à ? a. Une rétinopathie diabétique proliférative. b. Un traumatisme. c. Un décollement de rétine. d. Une occlusion de la veine centrale de la rétine. e. Une DMLA.",
                "corrected_response": "a. Une rétinopathie diabétique proliférative. b. Un traumatisme. c. Un décollement de rétine. d. Une occlusion de la veine centrale de la rétine." },

              {
                "question": "L'œdème de Berlin constitue une contusion du segment postérieur qui ? a. Se traduit par un niveau liquide hématique dans la chambre antérieure dont le risque est la récidive hémorragique. b. Apparaît sous la forme d'une hémorragie conjonctivale probablement due à une plaie sclérale sous-jacente ou un corps étranger. c. Évolue vers la résorption spontanée en tant qu'hémorragie intra-vitréenne empêchant la visualisation de la rétine. d. Est responsable d'une baisse d'acuité visuelle initiale souvent transitoire. e. Peut évoluer parfois vers la constitution d'un trou maculaire avec une baisse d'acuité visuelle définitive.",
                "corrected_response": "c. Sclérite." },
             {
                "question": "La rétinopathie diabétique ? a. C'est la manifestation de la micro-angiopathie diabétique. b. C'est la manifestation de la macroangiopathie diabétique. c. C'est l'affection vasculaire rétinienne la plus fréquente. d. Elle est toujours bilatérale. e. Elle survient uniquement chez le diabétique type 1.",
                "corrected_response": "a. C'est la manifestation de la micro-angiopathie diabétique. c. C'est l'affection vasculaire rétinienne la plus fréquente. d. Elle est toujours bilatérale." },
    {
               "question": " Question: A 26-year-old woman with multiple sclerosis comes to the physician because of a recent relapse Examination of the eye movements shows slow adduction of the left eye with an associated right-beating nystagmus in the right eye. Which of the following is the location of the pathology that underlies this abnormality? Options: A. Abducens nerve palsy B. Left medial longitudinal fasciculus C. Right medial longitudinal fasciculus D. Right oculomotor nerve",
               "corrected_response": "OPTION B IS CORRECT."
           },
            {
             "question": "Question: Homonymous hemianopia with usually sparing of the macula is seen in lesions of: Options: A. Geniculate body B. Optic radiations C. Visual coex D. All of the above",
             "corrected_response": "Ans. Visual coex OPTION C IS CORRECT.",
             }
           ,
             {
             "question": "Question: First sign of optic nerve disease is- Options: A. Papilloedema B. Colour blindness C. Afferent pupillary defect D. Efferent pupillary defect",
             "corrected_response": "Marcuss Gunn pupil or RAPD (relative afferent papillary defect) is the earliest indication of optic nerve disease even in presence of normal visual acuity. OPTION C IS CORRECT.",
             }
           ,

             {
             "question": "Question: Cataracts in a newborn is: Options: A. Zonular B. Nuclear C. Snowflake D. Cortical",
             "corrected_response": "a zonular refkhurana 3rd/e p. 187 OPTION A IS CORRECT.",
             },
            {
                "question": "La myopie d'indice est ? a. Est due à un début de cataracte b. Se voit dans les cataractes totales c. Se corrige par le laser d. Est due un allongement de l'axe antéro-postérieur du globe oculaire.",
               "corrected_response": "a. Est due à un début de cataracte. c. Se corrige par le laser."
            },
                        {
                "question": "La cataracte intumescente ? a. Est une cataracte congénitale. b. Est une cataracte en rosace. c. Elle peut se compliquer d'un décollement de rétine. d. Elle peut se compliquer d'une crise de glaucome par fermeture de l'angle secondaire. e. Elle est due à l'augmentation du volume du cristallin.",
               "corrected_response": "a. Est une cataracte congénitale. b. Est une cataracte en rosace. c. Elle peut se compliquer d'un décollement de rétine."
            }
            ],
     "General Ophthalmology QCM": [

         {
             "question": "Le décollement de rétine rhegmatogène ? a. Survient volontiers chez le myope. b. Est précédé d’une déchirure rétinienne. c. Se traduit par une amputation du champ visuel. d. Doit être opéré en urgence. e. Se traduit par une baisse d’acuité visuelle.",
              "corrected_response": "a. Survient volontiers chez le myope. b. Est précédé d’une déchirure rétinienne. c. Se traduit par une amputation du champ visuel. d. Doit être opéré en urgence. e. Se traduit par une baisse d’acuité visuelle."
        }  ,
        {
             "question": "Le syndrome de Claude Bernard-Horner est en rapport avec ? a. Un myosis. b. Une énophtalmie. c. Un ptosis. d. Une exophtalmie. e. Une paralysie du III.",
             "corrected_response": "a. Un myosis. b. Une énophtalmie. c. Un ptosis."
        },
           {
             "question": "Concernant le strabisme paralytique ? a. L'un des signes est la limitation de la motilité oculaire. b. Peut s'accompagner de céphalées. c. La diplopie est monoculaire. d. La déviation peut se majorer dans le regard dans le sens de la paralysie. e. Toutes les réponses sont justes.",
             "corrected_response": "a. L'un des signes est la limitation de la motilité oculaire. b. Peut s'accompagner de céphalées. d. La déviation peut se majorer dans le regard dans le sens de la paralysie."
        },
         {
             "question": "Le diagnostic de paralysie du III se fait sur les signes suivants, sauf un, lequel ? a. Strabisme divergent. b. Mydriase. c. Ptosis. d. Limitation de l’élévation et de l’abaissement de l’œil. e. Limitation de l’adduction de l’œil.",
             "corrected_response": "d. Limitation de l’élévation et de l’abaissement de l’œil."
        },
          {
             "question": "Concernant les paralysies oculomotrices ? a. Une diplopie binoculaire traduit souvent une paralysie oculomotrice. b. Une diplopie monoculaire traduit souvent une paralysie oculomotrice. c. Peuvent être révélatrices d’une maladie neurologique. d. Peuvent être révélatrices d’une maladie générale. e. Se manifestent par un ptosis.",
             "corrected_response": "a. Une diplopie binoculaire traduit souvent une paralysie oculomotrice. c. Peuvent être révélatrices d’une maladie neurologique. d. Peuvent être révélatrices d’une maladie générale."
        },

         {
             "question": "Un œil rouge, douloureux et dur peut faire suspecter une crise de glaucome aigu ou une uvéite antérieure hypertensive aiguë. Parmi les signes suivants, quel est celui qui permet de retenir sans hésitation le premier diagnostic ? a. L'œdème cornéen. b. La baisse de vision. c. La mydriase. d. La photophobie. e. Le larmoiement.",
             "corrected_response": "c. La mydriase."
        },
           {
             "question": "Les étiologies responsables de cercle péri kératiques sont ? a. Le glaucome aigu. b. La conjonctivite. c. L'hémorragie sous conjonctivale. d. La kératite. e. L'uvéite antérieure.",
             "corrected_response": "a. Le glaucome aigu. d. La kératite. e. L'uvéite antérieure."
        },

           {
             "question": "Question: Recovery in cataract surgery is fastest with which of the following - Options: A. ICCE B. ECCE C. Phacoemulsification D. ECCE with ICI",
             "corrected_response": "OPTION C IS CORRECT"
        },
          {
          "question": "Question: Which of the following drug is not used in glaucoma: Options: A. Pilicarpine. B. Physostigmine. C. Metoprolol. D. Timolol.",
          "corrected_response": "OPTION C IS CORRECT."},
        {
            "question":"Question: True about incontinenta pigmenti include the following except: Options: A. X-linked dominant B. Primary skin abnormality C. Avascularity of peripheral retina D. Ocular involvement is seen in almost 100% cases and is typically unilateral",
             "corrected_response": "OPTION D IS CORRECT. "
        }

   ],
    "Clinical Cases QCM": [

        {
            "question": "Question: A 32-year-old woman presents to the emergency department due to severe, intractable headaches, and bilateral ocular pain. Her symptoms began approximately 2 weeks prior to presentation and have progressively worsened. She initially had right-sided headaches that were sharp, interfered with sleep, and were unresponsive to pain medications. The headache was around her right eye and cheek, and she noticed diplopia with right lateral gaze. Her symptoms were accompanied by fatigue, fever, and edema around the right eye. Approximately 2 days after these symptoms, she developed swelling around the left eye. Medical history is significant for a recent rhinosinusitis infection. Her temperature is 101°F (38.3°C), blood pressure is 133/72 mmHg, pulse is 90/min, and respirations are 18/min. On physical exam, there is ptosis, proptosis, chemosis, and periorbital swelling of both eyes. There is hyperesthesia in the bilateral ophthalmic and maxillary divisions of the trigeminal nerve. Fundoscopic exam demonstrates bilateral papilledema. There is mydriasis and eye muscle weakness in all directions. Which of the following is the most likely diagnosis? Options: A. Acute angle-closure glaucoma B. Bacterial endophthalmitis C. Cavernous sinus thrombosis D. Orbital cellulitis",
            "corrected_response": "OPTION C IS CORRECT."},
        {
            "question": "Question: A 30-year-old man returns to the hospital 3 weeks after open reduction and internal fixation of left tibia and fibula fractures from a motor vehicle accident. The patient complains that his surgical site has been draining pus for a few days, and his visiting nurse told him to go to the emergency room after he had a fever this morning. On exam, his temperature is 103.0°F (39.4°C), blood pressure is 85/50 mmHg, pulse is 115/min, and respirations are 14/min. The ED physician further documents that the patient is also starting to develop a diffuse, macular rash. The patient is started on broad spectrum antibiotics, and Gram stain demonstrates purple cocci in clusters. Which of the following toxins is likely to be the cause of this patient's condition? Options: A. Alpha toxin B. Endotoxin C. Pyogenic exotoxin A D. Toxic shock syndrome toxin 1",
            "corrected_response": "OPTION D IS CORRECT."},
         {
            "question": "Question: A patient presented with scarring alopecia, thinned nails, hypopigmented macular lesions over the trunk and oral mucosa. The diagnosis is – Options: A. Psoriasis B. Leprosy C. Lichen planus D. None",
            "corrected_response": "OPTION D IS CORRECT."},
          {
            "question": "Question: A 7-year-old girl presents to a new pediatrician with fever, shortness of breath, and productive cough. She had similar symptoms a few weeks ago. The girl was born at 39 weeks gestation via spontaneous vaginal delivery. She is up to date on all vaccines and is meeting all developmental milestones. A further review of her history reveals seizures, upper respiratory infections, and cellulitis. On physical examination, the patient is pale with white-blonde hair and pale blue eyes. Which of the following would you expect to see on a peripheral blood smear for this patient? Options: A. Predominance of band leukocytes B. Downey cells C. Polymorphonuclear leukocytes containing giant inclusion bodies D. Significant basophil predominance",
            "corrected_response": "OPTION C IS CORRECT."}
           ,
           {
            "question": "Question: A 71-year-old woman comes to the office with a history of headaches, fatigue, and weight loss for 3 months. The headaches are new for her, and usually not very severe. Her jaw also hurts when she is chewing food. Two days prior, she had briefly lost partial vision in her left eye. There were no other neurologic symptoms at the time. On examination, her neck is supple to flexion, fundi and neurologic examinations are normal. She is started on prednisone 60 mg/day and a biopsy is performed to confirm the diagnosis. Which of the following is the most likely change seen on the biopsy to confirm the diagnosis? Options: A. immune complex deposition B. arteritis with giant cells C. lymphocytic infiltration D. type II muscle fiber atrophy",
            "corrected_response": "OPTION B IS CORRECT."
              },
          {
            "question": "Question: A previously healthy 10-year-old girl is brought to the physician because of severe malaise, pink eyes, cough, and a runny nose for 3 days. She recently immigrated from Sudan and immunization records are unavailable. Her temperature is 40.1°C (104.1°F). Examination shows bilateral conjunctival injections. There are multiple bluish-gray lesions on an erythematous buccal mucosa and soft palate. This patient is at increased risk for which of the following complications? Options: A. Immune thrombocytopenic purpura B. Subacute sclerosing panencephalitis C. Transient arrest of erythropoiesis D. Glomerular immune complex deposition",
            "corrected_response": "OPTION B IS CORRECT."

           },
        {
  "question": "Question: A 47-year-old woman is brought to the hospital by her husband with fever, headache, confusion, and jaundice for 1 week. She underwent a hysterectomy 2 months ago and began estrogen replacement therapy recently. On admission, her temperature is 38.7 C (102 F), blood pressure is 140/90 mm Hg, Pulse is 98/min, and Respiratory rate is 20/min. She appears disoriented to time and place. Physical examination reveals jaundiced sclerae and skin, purpura on the trunk, and bleeding gums. Her platelet count is 25,000/mm3, hematocrit is 24%, and creatinine is 4.9 mg/dL. Lactate dehydrogenase (LDH) and indirect bilirubin are elevated. Coagulation tests are within normal limits, but the bleeding time is increased; fibrin-split products and Coombs test are negative. A peripheral blood smear shows schistocytes, helmet-shaped cells, and cells with a triangular shape. Which of the following is the most likely diagnosis? Options: A. Autoimmune hemolytic anemia B. Disseminated intravascular coagulation (DIC) C. Hemolytic-uremic syndrome (HUS) D. Thrombotic thrombocytopenic purpura (TTP)",
  "corrected_response": "Option D: Thrombotic thrombocytopenic purpura (TTP) is the most likely diagnosis. It presents with microangiopathic hemolytic anemia, increased bleeding time, decreased platelet count, elevated indirect bilirubin and LDH, and characteristic findings on blood smear like schistocytes and helmet-shaped cells.",

},{
      "question": "Question: A 50-year-old man came to the ophthalmologist with the complaint of inability to read newspaper. His vision problem is likely due to inadequate contraction of which of the following structures? Options: A. Ciliary body B. Dilator pupillae C. Extraocular muscles D. Suspensory ligaments of lens",
     "corrected_response": "OPTION A IS CORRECT.",

},{
      "question": "Question: A 57-year-old man presents to the emergency department because he has been having abdominal pain for the past several months. Specifically, he complains of severe epigastric pain after eating that is sometimes accompanied by diarrhea. He has also lost 20 pounds over the same time period, which he attributes to the fact that the pain has been stopping him from wanting to eat. He does not recall any changes to his urine or stool. Physical exam reveals scleral icterus and a large non-tender gallbladder. Which of the following substances would most likely be elevated in the serum of this patient? Options: A. Alpha-fetoprotein B. CA-19-9 C. CEA D. PTHrP",
     "corrected_response": "OPTION B IS CORRECT.",

},
        {
            "question": "Question: A 6-month-old boy is brought to the emergency department by his mother because of recurrent vomiting and yellowing of his eyes. The mother says that he has been eating poorly since she started weaning him off of breast milk 5 days ago. At this time, mashed vegetables and fruits were added to his diet. Examination shows scleral jaundice and dry mucous membranes. The tip of the liver is palpable 4 cm below the right costal margin. His serum glucose concentration is 47 mg/dL, serum alanine aminotransferase is 55 U/L, and serum aspartate aminotransferase is 66 U/L. Which of the following enzymes is most likely deficient? Options: A. Galactokinase B. Galactose-1 phosphate uridyltransferase C. Aldolase B D. Glucose-6-phosphatase",
            "corrected_response": "OPTION C IS CORRECT."},

]


}

# Function to generate CSV data
def generate_csv_data(filename, num_rows=50):
    with open(filename, mode='w', newline='', encoding='utf-8') as file:
        writer = csv.writer(file)
        writer.writerow(columns)  # Write the header
        data = []
        for _ in range(num_rows):
            timestamp = pd.Timestamp.now().strftime("%Y-%m-%d %H:%M:%S")
            question_type = random.choice(question_types)
            question_entry = random.choice(sample_questions[question_type])
            question = question_entry["question"]
            corrected_response = question_entry["corrected_response"]
            evaluation = random.choice(responses)
            response_time = round(random.uniform(0.1, 60.0), 2)  # Response time in seconds
            if response_time >= 60:
                minutes = int(response_time // 60)
                seconds = response_time % 60
                formatted_time = f"{minutes} m {seconds:.2f} s"
            else:
                formatted_time = f"{response_time:.2f} s"
            row = [
                timestamp, question_type, question, corrected_response,
                evaluation, formatted_time
            ]
            data.append(row)
            writer.writerow(row)

    return data

# Generate the CSV file with a calculated number of rows
csv_filename = 'llm_evaluation_data.csv'
data = generate_csv_data(csv_filename, num_rows=len(sample_questions["Ocular Anatomy QCM"]) +
                                          len(sample_questions["Ocular Pathology QCM"]) +
                                          len(sample_questions["General Ophthalmology QCM"]) +
                                          len(sample_questions["Clinical Cases QCM"]))

# Download the CSV file from Google Colab
from google.colab import files
files.download(csv_filename)

# Display the data structure in a bordered table
from IPython.display import display, HTML
html_table = pd.DataFrame(data, columns=columns).head().to_html(index=False, border=1)
display(HTML(html_table))

"""

---
### **Loar Config Table Script Generator**
---



"""

import pandas as pd
from IPython.display import display, HTML
from google.colab import files

# Define your LoraConfig parameters
Lora_config = {
    "lora_alpha": 16,
    "lora_dropout": 0.1,
    "r": 64,
    "bias": "none",
    "task_type": "CAUSAL_LM",
    "target_modules": ["q_proj", "k_proj", "v_proj", "o_proj", "gate_proj"]
}

# Function to print LoraConfig parameters table
def print_loraconfig_table(Lora_config):
    # Convert data to a DataFrame
    df = pd.DataFrame([Lora_config])

    # Display the data structure in a bordered table
    html_table = df.to_html(index=False, border=1)
    display(HTML(html_table))

    # Return the DataFrame for further use
    return df

# Print LoraConfig parameters table and generate CSV
df = print_loraconfig_table(Lora_config)

# Generate the CSV file with LoraConfig parameters
csv_filename = 'Lora_config.csv'
df.to_csv(csv_filename, index=False)

# Download the CSV file from Google Colab
files.download(csv_filename)

"""

---

### **Model Trainable Parameters Generator Script**


---



---

"""

import csv
from google.colab import files
import pandas as pd
from IPython.display import display, HTML

# Function to generate model parameters CSV
def generate_model_parameters(filename):
    steps = 1000
    num_train_epochs = 2
    per_device_train_batch_size = 4
    gradient_accumulation_steps = 1
    optim = "paged_adamw_32bit"
    save_steps = 25
    logging_steps = 25
    learning_rate = 2e-4
    weight_decay = 0.001
    fp16 = False
    bf16 = True
    max_grad_norm = 0.3
    max_steps = -1
    warmup_ratio = 0.03
    group_by_length = True
    lr_scheduler_type = "constant"

    # Write to CSV
    with open(filename, mode='w', newline='', encoding='utf-8') as file:
        writer = csv.writer(file)
        writer.writerow(["steps", "num_train_epochs", "per_device_train_batch_size",
                         "gradient_accumulation_steps", "optim", "save_steps",
                         "logging_steps", "learning_rate", "weight_decay",
                         "fp16", "bf16", "max_grad_norm", "max_steps",
                         "warmup_ratio", "group_by_length", "lr_scheduler_type"])  # Write header

        # Write values as rows
        writer.writerow([steps, num_train_epochs, per_device_train_batch_size,
                         gradient_accumulation_steps, optim, save_steps,
                         logging_steps, learning_rate, weight_decay,
                         fp16, bf16, max_grad_norm, max_steps,
                         warmup_ratio, group_by_length, lr_scheduler_type])

# Generate model_parameters.csv
model_parameters_filename = 'model_parameters.csv'
generate_model_parameters(model_parameters_filename)

# Load CSV data into a Pandas DataFrame
df = pd.read_csv(model_parameters_filename)

# Display the data structure in a bordered table with all rows
html_table = df.to_html(index=False, border=1)
display(HTML(html_table))

# Download the CSV file from Google Colab
files.download(model_parameters_filename)

"""

---

###  **Training Results Generator Script**

---

---



"""

import csv
from google.colab import files
import pandas as pd
from IPython.display import display, HTML

# Function to generate training results CSV
def generate_training_results(filename, training_loss, train_runtime, train_samples_per_second, train_steps_per_second):
    # Write to CSV
    with open(filename, mode='w', newline='', encoding='utf-8') as file:
        writer = csv.writer(file)
        writer.writerow(["training_loss", "train_runtime", "train_samples_per_second", "train_steps_per_second"])  # Write header

        # Write values as rows
        writer.writerow([training_loss, train_runtime, train_samples_per_second, train_steps_per_second])

# Training results data
training_loss = 1.3143597297668457
train_runtime = 3436.8347
train_samples_per_second = 1.164
train_steps_per_second = 0.291

# Generate training_results.csv
training_results_filename = 'training_results.csv'
generate_training_results(training_results_filename, training_loss, train_runtime, train_samples_per_second, train_steps_per_second)

# Load CSV data into a Pandas DataFrame
df = pd.read_csv(training_results_filename)

# Display the data structure in a bordered table with all rows
html_table = df.to_html(index=False, border=1)
display(HTML(html_table))

# Download the CSV file from Google Colab
files.download(training_results_filename)

"""

---

### **DataBase Informations  Generator Script**

---

"""

import csv
from google.colab import files
import pandas as pd
from IPython.display import display, HTML


# Function to generate metadata CSV
def generate_metadata(filename):
    # Define the metadata
    metadata = [
        {"Database Name": "abirT/ophthalmologydataset", "Database Size": "1.24 MB", "Database Rows": 2000}

    ]

    # Define field names and their types
    fieldnames = ["Database Name", "Database Size", "Database Rows"]
    fieldtypes = [str, str, int]

    # Write to CSV
    with open(filename, mode='w', newline='', encoding='utf-8') as file:
        writer = csv.DictWriter(file, fieldnames=fieldnames)
        writer.writeheader()
        for data in metadata:
            # Convert data to specified types
            converted_data = {field: fieldtypes[i](data[field]) for i, field in enumerate(fieldnames)}
            writer.writerow(converted_data)

# Generate metadata.csv
metadata_filename = 'DatabaseDetails.csv'
generate_metadata(metadata_filename)

# Load CSV data into a Pandas DataFrame
df = pd.read_csv(metadata_filename)

# Display the data structure in a bordered table with all rows
html_table = df.to_html(index=False, border=1)
display(HTML(html_table))
# Download metadata.csv (for Google Colab)
from google.colab import files
files.download(metadata_filename)

"""

---

### Parameters Inference Generator Script

---

"""

import csv
import pandas as pd
from IPython.display import display, HTML

# Function to generate inference parameters CSV
def generate_inference_parameters(filename, inference_parameters):
    # Define column names (headers) as the keys of the inference parameters
    fieldnames = list(inference_parameters.keys())

    # Prepare the data row for inference parameters
    row = [value for value in inference_parameters.values()]

    # Write to CSV
    with open(filename, mode='w', newline='', encoding='utf-8') as file:
        writer = csv.writer(file)
        writer.writerow(fieldnames)  # Write header
        writer.writerow(row)  # Write row

# Inference parameters data
inference_parameters = {
    "Do_sample": True,
    "max_new_tokens": 100,
    "temperature": 0.7,
    "top_k": 50,
    "top_p": 0.95,
    "num_return_sequences": 1
}

# Generate inference_parameters.csv
inference_parameters_filename = 'inference_parameters.csv'
generate_inference_parameters(inference_parameters_filename, inference_parameters)

# Load CSV data into a Pandas DataFrame
df = pd.read_csv(inference_parameters_filename)

# Display the data structure in a bordered table with all rows
html_table = df.to_html(index=False, border=1)
display(HTML(html_table))

# Download the CSV file from Google Colab (if using Google Colab)
from google.colab import files
files.download(inference_parameters_filename)

"""

---

### Model Details Generator Script
---





---

"""

import csv
from google.colab import files
import pandas as pd
from IPython.display import display, HTML

# Function to generate model details CSV
def generate_model_details(filename, model_name, model_size, tensor_type, languages_supported, base_model):
    # Define column names (header)
    fieldnames = ["Model Name", "Model Size", "Tensor Type", "Languages Supported", "Base Model"]

    # Prepare the data rows for model details
    rows = [[model_name, model_size, tensor_type, languages_supported, base_model]]

    # Write to CSV
    with open(filename, mode='w', newline='', encoding='utf-8') as file:
        writer = csv.writer(file)
        writer.writerow(fieldnames)  # Write header
        writer.writerows(rows)  # Write rows

# Model details data
model_name = "Llama-2-7B-finetuning-ophtalmology"
model_size = "6.74B params"
tensor_type = "F32"
languages_supported = "French, English"
base_model = "Llama-2-7b-chat-hf"

# Generate model_details.csv
model_details_filename = 'model_details.csv'
generate_model_details(model_details_filename, model_name, model_size, tensor_type, languages_supported, base_model)

# Load CSV data into a Pandas DataFrame
df = pd.read_csv(model_details_filename)

# Display the data structure in a bordered table with all rows
html_table = df.to_html(index=False, border=1)
display(HTML(html_table))

# Download the CSV file from Google Colab
from google.colab import files
files.download(model_details_filename)

"""

---

### Random Generator Evaluation Script



---

"""

import csv
import datetime
import random
import pandas as pd
from collections import defaultdict
from sklearn.metrics import accuracy_score, precision_score, recall_score, f1_score
# Define the columns for the CSV file
columns = ["Timestamp",
           "Question Type",
           "Question",
           "Corrected Response",
           "Evaluation",
           "Response Time (s)",
           "Accuracy (%)",
           "Precision (%)",
           "Recall (%)",
           "F1 Score (%)",
           "Total Complet",
           "Total Incomplet",
           "Total Incorrect",
           "Total Responses"]


# Define the types of questions and possible responses
question_types = [
    "Ocular Anatomy QCM",
    "Ocular Pathology QCM",
    "General Ophthalmology QCM",
    "Clinical Cases QCM"
]

responses = ["complet", "incomplet", "incorrect"]
model_name = "abirT/Llama-2-7B-finetuning-ophtalmology"
model_response=" "

# questions and corrected responses
sample_questions = {
    "Ocular Anatomy QCM": [
        {
            "question": "La rétine ? a. Est un tissu neurosensoriel. b. Est composée de 5 couches. c. Au centre se trouve la macula comportant une forte concentration en bâtonnets et responsable de l’acuité visuelle maximale. d. Constituée de photorécepteurs de sorte que les cônes périphériques assurent la vision diurne et les cônes centraux la vision nocturne. e. Toutes les réponses sont fausses.",
            "corrected_response": "a. Est un tissu neurosensoriel."
        },
        {
            "question": "Le cristallin ? a. Est une lentille biconcave richement vascularisée. b. Il est responsable de l'accommodation. c. Sa caractéristique principale est la transparence. d. Est localisé entre l'iris et la chambre postérieure en avant et la rétine en arrière. e. Est suspendu au corps ciliaire par la zonule de ZINN.",
            "corrected_response": "a. Est une lentille biconcave richement vascularisée. d. Est localisé entre l'iris et la chambre postérieure en avant et la rétine en arrière."
        },
          {
            "question": "Les muscles oculomoteurs ? a. Assurent la motilité du globe oculaire. b. Le III innerve le droit externe. c. Le VI innerve le sphincter irien. d. Le III innerve l'oblique supérieure. e. Le IV innerve l'oblique inférieure",
            "corrected_response": "a. Assurent la motilité du globe oculaire."
        },
        {
            "question": "La longueur axiale ? a. Est la distance entre le sommet de la cornée et la rétine. b. La distance entre la cornée et le cristallin. c. Mesure entre 22 et 24 mm. d. Plus élevée chez le myope. e. Plus courte en cas d'astigmatisme.",
            "corrected_response": "a. Est la distance entre le sommet de la cornée et la rétine. c. Mesure entre 22 et 24 mm. d. Plus élevée chez le myope."
            },
         {
            "question": "La cornée ? a. Assure 1 / 3 du pouvoir réfractif du globe oculaire. b. Le test à la fluorescéine permet de rechercher une atteinte de l’endothélium cornéen. c. Le port de lentilles de contact est le principal facteur de risque des infections de la cornée. d. Les collyres corticoïdes retardent la cicatrisation de l'épithélium cornéen. e. Dans les brûlures chimiques, les acides pénètrent très rapidement dans le stroma cornéen.",
            "corrected_response": "c. Le port de lentilles de contact est le principal facteur de risque des infections de la cornée. d. Les collyres corticoïdes retardent la cicatrisation de l'épithélium cornéen." },
         {
            "question": "La microscopie spéculaire ? a. Elle permet le calcul du rayon de courbure de la cornée. b. Elle permet le calcul de la longueur axiale. c. Elle permet le calcul du comptage des cellules endothéliales cornéennes. d. Elle permet l'exploration du segment postérieur de l'œil. e. Elle permet une coupe presque histologique de la rétine.",
            "corrected_response": "c. Elle permet le calcul du comptage des cellules endothéliales cornéennes."
             },
         {
            "question": "Concernant les voies lacrymales ? a. L'imperméabilité des voies lacrymales peut donner un larmoiement. b. Une sténose des voies lacrymales nécessite parfois une intervention chirurgicale. c. L'imperméabilité des voies lacrymales se diagnostique par un test au bleu de méthylène. d. L'imperméabilité des voies lacrymales peut donner une kératite. e. Un larmoiement chronique impose un bilan ophtalmologique.",
            "corrected_response": "a. L'imperméabilité des voies lacrymales peut donner un larmoiement. b. Une sténose des voies lacrymales nécessite parfois une intervention chirurgicale. d. L'imperméabilité des voies lacrymales peut donner une kératite. e. Un larmoiement chronique impose un bilan ophtalmologique." }
             ,
           {
            "question": "Question: Diameter of the macula lutea is: Options: A. 1.5 mm B. 3.5 mm C. 4.5 mm D. 5.5 mm",
            "corrected_response": "OPTION D IS CORRECT."
             },
         {
            "question": "Question: Corneal endothelium is embryologically derived from Options: A. Neural crest B. Ectoderm C. Mesoderm D. Endoderm",
            "corrected_response": "OPTION A IS CORRECT."
             },
        {
            "question":" Question: Lamina cribrosa is not present in Options: A. Morning glory syndrome B. Nanophthalmia C. Coloboma of retina D. Optic nerve agenesis",
            "corrected_response": "Morning glory syndrome is a mesodermal defect in which there is peripapillary defect along with absence of lamina cribrosa. OPTION A IS CORRECT."
        }




   ],
    "Ocular Pathology QCM": [


             {
                "question": "L'héméralopie est liée à ? a. La cataracte. b. Un diabète. c. La rétinite pigmentaire. d. Un décollement de rétine. e. La DMLA.",
                "corrected_response": "c. La rétinite pigmentaire." },
            {
                "question": "Une hémorragie intravitréenne peut être due à ? a. Une rétinopathie diabétique proliférative. b. Un traumatisme. c. Un décollement de rétine. d. Une occlusion de la veine centrale de la rétine. e. Une DMLA.",
                "corrected_response": "a. Une rétinopathie diabétique proliférative. b. Un traumatisme. c. Un décollement de rétine. d. Une occlusion de la veine centrale de la rétine." },

              {
                "question": "L'œdème de Berlin constitue une contusion du segment postérieur qui ? a. Se traduit par un niveau liquide hématique dans la chambre antérieure dont le risque est la récidive hémorragique. b. Apparaît sous la forme d'une hémorragie conjonctivale probablement due à une plaie sclérale sous-jacente ou un corps étranger. c. Évolue vers la résorption spontanée en tant qu'hémorragie intra-vitréenne empêchant la visualisation de la rétine. d. Est responsable d'une baisse d'acuité visuelle initiale souvent transitoire. e. Peut évoluer parfois vers la constitution d'un trou maculaire avec une baisse d'acuité visuelle définitive.",
                "corrected_response": "c. Sclérite." },
             {
                "question": "La rétinopathie diabétique ? a. C'est la manifestation de la micro-angiopathie diabétique. b. C'est la manifestation de la macroangiopathie diabétique. c. C'est l'affection vasculaire rétinienne la plus fréquente. d. Elle est toujours bilatérale. e. Elle survient uniquement chez le diabétique type 1.",
                "corrected_response": "a. C'est la manifestation de la micro-angiopathie diabétique. c. C'est l'affection vasculaire rétinienne la plus fréquente. d. Elle est toujours bilatérale." },
    {
               "question": " Question: A 26-year-old woman with multiple sclerosis comes to the physician because of a recent relapse Examination of the eye movements shows slow adduction of the left eye with an associated right-beating nystagmus in the right eye. Which of the following is the location of the pathology that underlies this abnormality? Options: A. Abducens nerve palsy B. Left medial longitudinal fasciculus C. Right medial longitudinal fasciculus D. Right oculomotor nerve",
               "corrected_response": "OPTION B IS CORRECT."
           },
            {
             "question": "Question: Homonymous hemianopia with usually sparing of the macula is seen in lesions of: Options: A. Geniculate body B. Optic radiations C. Visual coex D. All of the above",
             "corrected_response": "Ans. Visual coex OPTION C IS CORRECT.",
             }
           ,
             {
             "question": "Question: First sign of optic nerve disease is- Options: A. Papilloedema B. Colour blindness C. Afferent pupillary defect D. Efferent pupillary defect",
             "corrected_response": "Marcuss Gunn pupil or RAPD (relative afferent papillary defect) is the earliest indication of optic nerve disease even in presence of normal visual acuity. OPTION C IS CORRECT.",
             }
           ,

             {
             "question": "Question: Cataracts in a newborn is: Options: A. Zonular B. Nuclear C. Snowflake D. Cortical",
             "corrected_response": "a zonular refkhurana 3rd/e p. 187 OPTION A IS CORRECT.",
             },
            {
                "question": "La myopie d'indice est ? a. Est due à un début de cataracte b. Se voit dans les cataractes totales c. Se corrige par le laser d. Est due un allongement de l'axe antéro-postérieur du globe oculaire.",
               "corrected_response": "a. Est due à un début de cataracte. c. Se corrige par le laser."
            },
                        {
                "question": "La cataracte intumescente ? a. Est une cataracte congénitale. b. Est une cataracte en rosace. c. Elle peut se compliquer d'un décollement de rétine. d. Elle peut se compliquer d'une crise de glaucome par fermeture de l'angle secondaire. e. Elle est due à l'augmentation du volume du cristallin.",
               "corrected_response": "a. Est une cataracte congénitale. b. Est une cataracte en rosace. c. Elle peut se compliquer d'un décollement de rétine."
            }
            ],
     "General Ophthalmology QCM": [

         {
             "question": "Le décollement de rétine rhegmatogène ? a. Survient volontiers chez le myope. b. Est précédé d’une déchirure rétinienne. c. Se traduit par une amputation du champ visuel. d. Doit être opéré en urgence. e. Se traduit par une baisse d’acuité visuelle.",
              "corrected_response": "a. Survient volontiers chez le myope. b. Est précédé d’une déchirure rétinienne. c. Se traduit par une amputation du champ visuel. d. Doit être opéré en urgence. e. Se traduit par une baisse d’acuité visuelle."
        }  ,
        {
             "question": "Le syndrome de Claude Bernard-Horner est en rapport avec ? a. Un myosis. b. Une énophtalmie. c. Un ptosis. d. Une exophtalmie. e. Une paralysie du III.",
             "corrected_response": "a. Un myosis. b. Une énophtalmie. c. Un ptosis."
        },
           {
             "question": "Concernant le strabisme paralytique ? a. L'un des signes est la limitation de la motilité oculaire. b. Peut s'accompagner de céphalées. c. La diplopie est monoculaire. d. La déviation peut se majorer dans le regard dans le sens de la paralysie. e. Toutes les réponses sont justes.",
             "corrected_response": "a. L'un des signes est la limitation de la motilité oculaire. b. Peut s'accompagner de céphalées. d. La déviation peut se majorer dans le regard dans le sens de la paralysie."
        },
         {
             "question": "Le diagnostic de paralysie du III se fait sur les signes suivants, sauf un, lequel ? a. Strabisme divergent. b. Mydriase. c. Ptosis. d. Limitation de l’élévation et de l’abaissement de l’œil. e. Limitation de l’adduction de l’œil.",
             "corrected_response": "d. Limitation de l’élévation et de l’abaissement de l’œil."
        },
          {
             "question": "Concernant les paralysies oculomotrices ? a. Une diplopie binoculaire traduit souvent une paralysie oculomotrice. b. Une diplopie monoculaire traduit souvent une paralysie oculomotrice. c. Peuvent être révélatrices d’une maladie neurologique. d. Peuvent être révélatrices d’une maladie générale. e. Se manifestent par un ptosis.",
             "corrected_response": "a. Une diplopie binoculaire traduit souvent une paralysie oculomotrice. c. Peuvent être révélatrices d’une maladie neurologique. d. Peuvent être révélatrices d’une maladie générale."
        },

         {
             "question": "Un œil rouge, douloureux et dur peut faire suspecter une crise de glaucome aigu ou une uvéite antérieure hypertensive aiguë. Parmi les signes suivants, quel est celui qui permet de retenir sans hésitation le premier diagnostic ? a. L'œdème cornéen. b. La baisse de vision. c. La mydriase. d. La photophobie. e. Le larmoiement.",
             "corrected_response": "c. La mydriase."
        },
           {
             "question": "Les étiologies responsables de cercle péri kératiques sont ? a. Le glaucome aigu. b. La conjonctivite. c. L'hémorragie sous conjonctivale. d. La kératite. e. L'uvéite antérieure.",
             "corrected_response": "a. Le glaucome aigu. d. La kératite. e. L'uvéite antérieure."
        },

           {
             "question": "Question: Recovery in cataract surgery is fastest with which of the following - Options: A. ICCE B. ECCE C. Phacoemulsification D. ECCE with ICI",
             "corrected_response": "OPTION C IS CORRECT"
        },
          {
          "question": "Question: Which of the following drug is not used in glaucoma: Options: A. Pilicarpine. B. Physostigmine. C. Metoprolol. D. Timolol.",
          "corrected_response": "OPTION C IS CORRECT."},
        {
            "question":"Question: True about incontinenta pigmenti include the following except: Options: A. X-linked dominant B. Primary skin abnormality C. Avascularity of peripheral retina D. Ocular involvement is seen in almost 100% cases and is typically unilateral",
             "corrected_response": "OPTION D IS CORRECT. "
        }

   ],
    "Clinical Cases QCM": [

        {
            "question": "Question: A 32-year-old woman presents to the emergency department due to severe, intractable headaches, and bilateral ocular pain. Her symptoms began approximately 2 weeks prior to presentation and have progressively worsened. She initially had right-sided headaches that were sharp, interfered with sleep, and were unresponsive to pain medications. The headache was around her right eye and cheek, and she noticed diplopia with right lateral gaze. Her symptoms were accompanied by fatigue, fever, and edema around the right eye. Approximately 2 days after these symptoms, she developed swelling around the left eye. Medical history is significant for a recent rhinosinusitis infection. Her temperature is 101°F (38.3°C), blood pressure is 133/72 mmHg, pulse is 90/min, and respirations are 18/min. On physical exam, there is ptosis, proptosis, chemosis, and periorbital swelling of both eyes. There is hyperesthesia in the bilateral ophthalmic and maxillary divisions of the trigeminal nerve. Fundoscopic exam demonstrates bilateral papilledema. There is mydriasis and eye muscle weakness in all directions. Which of the following is the most likely diagnosis? Options: A. Acute angle-closure glaucoma B. Bacterial endophthalmitis C. Cavernous sinus thrombosis D. Orbital cellulitis",
            "corrected_response": "OPTION C IS CORRECT."},
        {
            "question": "Question: A 30-year-old man returns to the hospital 3 weeks after open reduction and internal fixation of left tibia and fibula fractures from a motor vehicle accident. The patient complains that his surgical site has been draining pus for a few days, and his visiting nurse told him to go to the emergency room after he had a fever this morning. On exam, his temperature is 103.0°F (39.4°C), blood pressure is 85/50 mmHg, pulse is 115/min, and respirations are 14/min. The ED physician further documents that the patient is also starting to develop a diffuse, macular rash. The patient is started on broad spectrum antibiotics, and Gram stain demonstrates purple cocci in clusters. Which of the following toxins is likely to be the cause of this patient's condition? Options: A. Alpha toxin B. Endotoxin C. Pyogenic exotoxin A D. Toxic shock syndrome toxin 1",
            "corrected_response": "OPTION D IS CORRECT."},
         {
            "question": "Question: A patient presented with scarring alopecia, thinned nails, hypopigmented macular lesions over the trunk and oral mucosa. The diagnosis is – Options: A. Psoriasis B. Leprosy C. Lichen planus D. None",
            "corrected_response": "OPTION D IS CORRECT."},
          {
            "question": "Question: A 7-year-old girl presents to a new pediatrician with fever, shortness of breath, and productive cough. She had similar symptoms a few weeks ago. The girl was born at 39 weeks gestation via spontaneous vaginal delivery. She is up to date on all vaccines and is meeting all developmental milestones. A further review of her history reveals seizures, upper respiratory infections, and cellulitis. On physical examination, the patient is pale with white-blonde hair and pale blue eyes. Which of the following would you expect to see on a peripheral blood smear for this patient? Options: A. Predominance of band leukocytes B. Downey cells C. Polymorphonuclear leukocytes containing giant inclusion bodies D. Significant basophil predominance",
            "corrected_response": "OPTION C IS CORRECT."}
           ,
           {
            "question": "Question: A 71-year-old woman comes to the office with a history of headaches, fatigue, and weight loss for 3 months. The headaches are new for her, and usually not very severe. Her jaw also hurts when she is chewing food. Two days prior, she had briefly lost partial vision in her left eye. There were no other neurologic symptoms at the time. On examination, her neck is supple to flexion, fundi and neurologic examinations are normal. She is started on prednisone 60 mg/day and a biopsy is performed to confirm the diagnosis. Which of the following is the most likely change seen on the biopsy to confirm the diagnosis? Options: A. immune complex deposition B. arteritis with giant cells C. lymphocytic infiltration D. type II muscle fiber atrophy",
            "corrected_response": "OPTION B IS CORRECT."
              },
          {
            "question": "Question: A previously healthy 10-year-old girl is brought to the physician because of severe malaise, pink eyes, cough, and a runny nose for 3 days. She recently immigrated from Sudan and immunization records are unavailable. Her temperature is 40.1°C (104.1°F). Examination shows bilateral conjunctival injections. There are multiple bluish-gray lesions on an erythematous buccal mucosa and soft palate. This patient is at increased risk for which of the following complications? Options: A. Immune thrombocytopenic purpura B. Subacute sclerosing panencephalitis C. Transient arrest of erythropoiesis D. Glomerular immune complex deposition",
            "corrected_response": "OPTION B IS CORRECT."

           },
        {
  "question": "Question: A 47-year-old woman is brought to the hospital by her husband with fever, headache, confusion, and jaundice for 1 week. She underwent a hysterectomy 2 months ago and began estrogen replacement therapy recently. On admission, her temperature is 38.7 C (102 F), blood pressure is 140/90 mm Hg, Pulse is 98/min, and Respiratory rate is 20/min. She appears disoriented to time and place. Physical examination reveals jaundiced sclerae and skin, purpura on the trunk, and bleeding gums. Her platelet count is 25,000/mm3, hematocrit is 24%, and creatinine is 4.9 mg/dL. Lactate dehydrogenase (LDH) and indirect bilirubin are elevated. Coagulation tests are within normal limits, but the bleeding time is increased; fibrin-split products and Coombs test are negative. A peripheral blood smear shows schistocytes, helmet-shaped cells, and cells with a triangular shape. Which of the following is the most likely diagnosis? Options: A. Autoimmune hemolytic anemia B. Disseminated intravascular coagulation (DIC) C. Hemolytic-uremic syndrome (HUS) D. Thrombotic thrombocytopenic purpura (TTP)",
  "corrected_response": "Option D: Thrombotic thrombocytopenic purpura (TTP) is the most likely diagnosis. It presents with microangiopathic hemolytic anemia, increased bleeding time, decreased platelet count, elevated indirect bilirubin and LDH, and characteristic findings on blood smear like schistocytes and helmet-shaped cells.",

},{
      "question": "Question: A 50-year-old man came to the ophthalmologist with the complaint of inability to read newspaper. His vision problem is likely due to inadequate contraction of which of the following structures? Options: A. Ciliary body B. Dilator pupillae C. Extraocular muscles D. Suspensory ligaments of lens",
     "corrected_response": "OPTION A IS CORRECT.",

},{
      "question": "Question: A 57-year-old man presents to the emergency department because he has been having abdominal pain for the past several months. Specifically, he complains of severe epigastric pain after eating that is sometimes accompanied by diarrhea. He has also lost 20 pounds over the same time period, which he attributes to the fact that the pain has been stopping him from wanting to eat. He does not recall any changes to his urine or stool. Physical exam reveals scleral icterus and a large non-tender gallbladder. Which of the following substances would most likely be elevated in the serum of this patient? Options: A. Alpha-fetoprotein B. CA-19-9 C. CEA D. PTHrP",
     "corrected_response": "OPTION B IS CORRECT.",

},
        {
            "question": "Question: A 6-month-old boy is brought to the emergency department by his mother because of recurrent vomiting and yellowing of his eyes. The mother says that he has been eating poorly since she started weaning him off of breast milk 5 days ago. At this time, mashed vegetables and fruits were added to his diet. Examination shows scleral jaundice and dry mucous membranes. The tip of the liver is palpable 4 cm below the right costal margin. His serum glucose concentration is 47 mg/dL, serum alanine aminotransferase is 55 U/L, and serum aspartate aminotransferase is 66 U/L. Which of the following enzymes is most likely deficient? Options: A. Galactokinase B. Galactose-1 phosphate uridyltransferase C. Aldolase B D. Glucose-6-phosphatase",
            "corrected_response": "OPTION C IS CORRECT."},

]


}


# Function to generate CSV data
def generate_csv_data(filename, num_rows=50):
    with open(filename, mode='w', newline='', encoding='utf-8') as file:
        writer = csv.writer(file)
        writer.writerow(columns)  # Write the header

        for _ in range(num_rows):
            timestamp = pd.Timestamp.now().strftime("%Y-%m-%d %H:%M:%S")
            question_type = random.choice(question_types)
            question_entry = random.choice(sample_questions[question_type])
            question = question_entry["question"]
            corrected_response = question_entry["corrected_response"]
            evaluation = random.choice(responses)
            response_time = round(random.uniform(0.1, 60.0), 2)  # Response time in seconds
            if response_time >= 60:
               minutes = int(response_time // 60)
               seconds = response_time % 60
               formatted_time = f"{minutes} m {seconds:.2f} s"
            else:
              formatted_time = f"{response_time:.2f} s"
            writer.writerow([
                timestamp, question_type, question, corrected_response,
                evaluation, formatted_time,"","","","","","","",""
            ])

# Function to calculate performance metrics from the CSV file
def calculate_metrics_from_csv(filename):
    metrics_dict = defaultdict(lambda: defaultdict(int))

    # Read CSV file and calculate metrics
    with open(filename, mode='r', newline='', encoding='utf-8') as file:
        reader = csv.DictReader(file)
        for row in reader:
            question_type = row["Question Type"]
            evaluation = row["Evaluation"]

            metrics_dict[question_type]["Total Responses"] += 1

            if evaluation == "complet":
                metrics_dict[question_type]["Total Complet"] += 1
            elif evaluation == "incomplet":
                metrics_dict[question_type]["Total Incomplet"] += 1
            elif evaluation == "incorrect":
                metrics_dict[question_type]["Total Incorrect"] += 1

    # Calculate accuracy, precision, recall, and F1-score
    for question_type, metrics in metrics_dict.items():
        total_responses = metrics["Total Responses"]
        total_complet = metrics["Total Complet"]
        total_incomplet = metrics["Total Incomplet"]
        total_incorrect = metrics["Total Incorrect"]

        # Calculate Accuracy
        accuracy = (total_complet / total_responses) * 100 if total_responses > 0 else 0.0
        metrics_dict[question_type]["Accuracy (%)"] = f"{accuracy:.2f}%"

        # Calculate Precision, Recall, F1 Score
        precision = (total_complet / (total_complet + total_incomplet + total_incorrect)) * 100 if (total_complet + total_incomplet + total_incorrect) > 0 else 0.0
        recall = (total_complet / (total_complet + total_incorrect)) * 100 if (total_complet + total_incorrect) > 0 else 0.0
        f1_score = (2 * precision * recall) / (precision + recall) if (precision + recall) > 0 else 0.0

        metrics_dict[question_type]["Precision (%)"] = f"{precision:.2f}%"
        metrics_dict[question_type]["Recall (%)"] = f"{recall:.2f}%"
        metrics_dict[question_type]["F1 Score (%)"] = f"{f1_score:.2f}%"

    # Update the CSV file with calculated metrics
    rows = []
    with open(filename, mode='r', newline='', encoding='utf-8') as file:
        reader = csv.DictReader(file)
        for row in reader:
            question_type = row["Question Type"]
            metrics = metrics_dict[question_type]

            row["Accuracy (%)"] = metrics["Accuracy (%)"]
            row["Precision (%)"] = metrics["Precision (%)"]
            row["Recall (%)"] = metrics["Recall (%)"]
            row["F1 Score (%)"] = metrics["F1 Score (%)"]
            row["Total Responses"] = metrics["Total Responses"]
            row["Total Complet"] = metrics["Total Complet"]
            row["Total Incomplet"] = metrics["Total Incomplet"]
            row["Total Incorrect"] = metrics["Total Incorrect"]

            rows.append(row)

    # Write back updated rows to CSV
    with open(filename, mode='w', newline='', encoding='utf-8') as file:
        writer = csv.DictWriter(file, fieldnames=columns)
        writer.writeheader()
        writer.writerows(rows)

# Generate the CSV file with 50 rows (adjust num_rows as needed)
csv_filename = 'llm_evaluation_data.csv'
generate_csv_data(csv_filename, num_rows=len(sample_questions["Ocular Anatomy QCM"]) +
                                     len(sample_questions["Ocular Pathology QCM"]) +
                                     len(sample_questions["General Ophthalmology QCM"]) +
                                     len(sample_questions["Clinical Cases QCM"]))

# Calculate metrics from the generated CSV file
calculate_metrics_from_csv(csv_filename)

# Download the CSV file from Google Colab
from google.colab import files
files.download(csv_filename)

"""

---


### **Test Llama 2 7b model befor the Fine-tuning**

---

"""

import time
from transformers import pipeline

# Load the model
model_name = "NousResearch/Llama-2-7b-chat-hf"
model_pipeline = pipeline("text-generation", model=model_name)

# Function to extract the response after [/INST]
def extract_model_response(full_response):
    response_start = full_response.find('[/INST]') + len('[/INST]')
    extracted_response = full_response[response_start:].strip()
    return extracted_response

# Function to get the model's response for a given question
def get_model_response(question):
    start_time = time.time()
    full_model_response = model_pipeline(f"<s>[INST] {question} [/INST]", max_new_tokens=250, num_return_sequences=1)[0]['generated_text']
    end_time = time.time()
    response_time = end_time - start_time
    model_response = extract_model_response(full_model_response)
    return model_response, full_model_response, response_time

# List to store traceability of inputs and outputs
traceability = []

# Manually enter questions and get model responses
while True:
    question = input("Enter your question (or type 'exit' to quit): ")
    if question.lower() == 'exit':
        break
    model_response, full_model_response, response_time = get_model_response(question)
    traceability.append({'question': question, 'full_response': full_model_response, 'extracted_response': model_response, 'response_time': response_time})
    print(f"Model Response: {model_response}")
    print(f"Response Time: {response_time:.2f} seconds")

# Display all traceability records
print("\nTraceability Records:")
for record in traceability:
    print(f"Question: {record['question']}")
    print(f"Full Response: {record['full_response']}")
    print(f"Extracted Response: {record['extracted_response']}")
    print(f"Response Time: {record['response_time']:.2f} seconds")
    print("\n")

"""





---

### **Automated Evaluation of Model Responses for Multiple Choice Questions (QCMs)**

---



---



"""

import csv
import datetime
import random
import pandas as pd
from transformers import (
    AutoModelForCausalLM,
    AutoTokenizer,
    pipeline
)
import time

# Define the columns for the CSV file
columns = ["Timestamp",
           "Model Name",
           "Question Type",
           "Question",
           "Corrected Response",
           "Evaluation",
           "Model Response",
           "Response Time (s)"]

# Define the types of questions and possible responses
question_types = [
    "Ocular Anatomy QCM",
    "Ocular Pathology QCM",
    "General Ophthalmology QCM",
    "Clinical Cases QCM"
]

responses = ["complet", "incomplet", "incorrect"]
model_name = "abirT/Llama-2-7B-finetuning-ophtalmology"
model_response=" "

model_name = "abirT/Llama-2-7B-finetuning-ophtalmology"
# Initialize pipeline with the loaded model and tokenizer
model_pipeline = pipeline("text-generation", model=model_name)

# questions and corrected responses
# questions and corrected responses
sample_questions = {
    "Ocular Anatomy QCM": [
        {
            "question": "La rétine ? a. Est un tissu neurosensoriel. b. Est composée de 5 couches. c. Au centre se trouve la macula comportant une forte concentration en bâtonnets et responsable de l’acuité visuelle maximale. d. Constituée de photorécepteurs de sorte que les cônes périphériques assurent la vision diurne et les cônes centraux la vision nocturne. e. Toutes les réponses sont fausses.",
            "corrected_response": "a. Est un tissu neurosensoriel."
        },
        {
            "question": "Le cristallin ? a. Est une lentille biconcave richement vascularisée. b. Il est responsable de l'accommodation. c. Sa caractéristique principale est la transparence. d. Est localisé entre l'iris et la chambre postérieure en avant et la rétine en arrière. e. Est suspendu au corps ciliaire par la zonule de ZINN.",
            "corrected_response": "a. Est une lentille biconcave richement vascularisée. d. Est localisé entre l'iris et la chambre postérieure en avant et la rétine en arrière."
        },
          {
            "question": "Les muscles oculomoteurs ? a. Assurent la motilité du globe oculaire. b. Le III innerve le droit externe. c. Le VI innerve le sphincter irien. d. Le III innerve l'oblique supérieure. e. Le IV innerve l'oblique inférieure",
            "corrected_response": "a. Assurent la motilité du globe oculaire."
        },
        {
            "question": "La longueur axiale ? a. Est la distance entre le sommet de la cornée et la rétine. b. La distance entre la cornée et le cristallin. c. Mesure entre 22 et 24 mm. d. Plus élevée chez le myope. e. Plus courte en cas d'astigmatisme.",
            "corrected_response": "a. Est la distance entre le sommet de la cornée et la rétine. c. Mesure entre 22 et 24 mm. d. Plus élevée chez le myope."
            },
         {
            "question": "La cornée ? a. Assure 1 / 3 du pouvoir réfractif du globe oculaire. b. Le test à la fluorescéine permet de rechercher une atteinte de l’endothélium cornéen. c. Le port de lentilles de contact est le principal facteur de risque des infections de la cornée. d. Les collyres corticoïdes retardent la cicatrisation de l'épithélium cornéen. e. Dans les brûlures chimiques, les acides pénètrent très rapidement dans le stroma cornéen.",
            "corrected_response": "c. Le port de lentilles de contact est le principal facteur de risque des infections de la cornée. d. Les collyres corticoïdes retardent la cicatrisation de l'épithélium cornéen." },
         {
            "question": "La microscopie spéculaire ? a. Elle permet le calcul du rayon de courbure de la cornée. b. Elle permet le calcul de la longueur axiale. c. Elle permet le calcul du comptage des cellules endothéliales cornéennes. d. Elle permet l'exploration du segment postérieur de l'œil. e. Elle permet une coupe presque histologique de la rétine.",
            "corrected_response": "c. Elle permet le calcul du comptage des cellules endothéliales cornéennes."
             },
         {
            "question": "Concernant les voies lacrymales ? a. L'imperméabilité des voies lacrymales peut donner un larmoiement. b. Une sténose des voies lacrymales nécessite parfois une intervention chirurgicale. c. L'imperméabilité des voies lacrymales se diagnostique par un test au bleu de méthylène. d. L'imperméabilité des voies lacrymales peut donner une kératite. e. Un larmoiement chronique impose un bilan ophtalmologique.",
            "corrected_response": "a. L'imperméabilité des voies lacrymales peut donner un larmoiement. b. Une sténose des voies lacrymales nécessite parfois une intervention chirurgicale. d. L'imperméabilité des voies lacrymales peut donner une kératite. e. Un larmoiement chronique impose un bilan ophtalmologique." }
             ,
           {
            "question": "Question: Diameter of the macula lutea is: Options: A. 1.5 mm B. 3.5 mm C. 4.5 mm D. 5.5 mm",
            "corrected_response": "OPTION D IS CORRECT."
             },
         {
            "question": "Question: Corneal endothelium is embryologically derived from Options: A. Neural crest B. Ectoderm C. Mesoderm D. Endoderm",
            "corrected_response": "OPTION A IS CORRECT."
             },
        {
            "question":" Question: Lamina cribrosa is not present in Options: A. Morning glory syndrome B. Nanophthalmia C. Coloboma of retina D. Optic nerve agenesis",
            "corrected_response": "Morning glory syndrome is a mesodermal defect in which there is peripapillary defect along with absence of lamina cribrosa. OPTION A IS CORRECT."
        }




   ],
    "Ocular Pathology QCM": [


             {
                "question": "L'héméralopie est liée à ? a. La cataracte. b. Un diabète. c. La rétinite pigmentaire. d. Un décollement de rétine. e. La DMLA.",
                "corrected_response": "c. La rétinite pigmentaire." },
            {
                "question": "Une hémorragie intravitréenne peut être due à ? a. Une rétinopathie diabétique proliférative. b. Un traumatisme. c. Un décollement de rétine. d. Une occlusion de la veine centrale de la rétine. e. Une DMLA.",
                "corrected_response": "a. Une rétinopathie diabétique proliférative. b. Un traumatisme. c. Un décollement de rétine. d. Une occlusion de la veine centrale de la rétine." },

              {
                "question": "L'œdème de Berlin constitue une contusion du segment postérieur qui ? a. Se traduit par un niveau liquide hématique dans la chambre antérieure dont le risque est la récidive hémorragique. b. Apparaît sous la forme d'une hémorragie conjonctivale probablement due à une plaie sclérale sous-jacente ou un corps étranger. c. Évolue vers la résorption spontanée en tant qu'hémorragie intra-vitréenne empêchant la visualisation de la rétine. d. Est responsable d'une baisse d'acuité visuelle initiale souvent transitoire. e. Peut évoluer parfois vers la constitution d'un trou maculaire avec une baisse d'acuité visuelle définitive.",
                "corrected_response": "c. Sclérite." },
             {
                "question": "La rétinopathie diabétique ? a. C'est la manifestation de la micro-angiopathie diabétique. b. C'est la manifestation de la macroangiopathie diabétique. c. C'est l'affection vasculaire rétinienne la plus fréquente. d. Elle est toujours bilatérale. e. Elle survient uniquement chez le diabétique type 1.",
                "corrected_response": "a. C'est la manifestation de la micro-angiopathie diabétique. c. C'est l'affection vasculaire rétinienne la plus fréquente. d. Elle est toujours bilatérale." },
    {
               "question": " Question: A 26-year-old woman with multiple sclerosis comes to the physician because of a recent relapse Examination of the eye movements shows slow adduction of the left eye with an associated right-beating nystagmus in the right eye. Which of the following is the location of the pathology that underlies this abnormality? Options: A. Abducens nerve palsy B. Left medial longitudinal fasciculus C. Right medial longitudinal fasciculus D. Right oculomotor nerve",
               "corrected_response": "OPTION B IS CORRECT."
           },
            {
             "question": "Question: Homonymous hemianopia with usually sparing of the macula is seen in lesions of: Options: A. Geniculate body B. Optic radiations C. Visual coex D. All of the above",
             "corrected_response": "Ans. Visual coex OPTION C IS CORRECT.",
             }
           ,
             {
             "question": "Question: First sign of optic nerve disease is- Options: A. Papilloedema B. Colour blindness C. Afferent pupillary defect D. Efferent pupillary defect",
             "corrected_response": "Marcuss Gunn pupil or RAPD (relative afferent papillary defect) is the earliest indication of optic nerve disease even in presence of normal visual acuity. OPTION C IS CORRECT.",
             }
           ,

             {
             "question": "Question: Cataracts in a newborn is: Options: A. Zonular B. Nuclear C. Snowflake D. Cortical",
             "corrected_response": "a zonular refkhurana 3rd/e p. 187 OPTION A IS CORRECT.",
             },
            {
                "question": "La myopie d'indice est ? a. Est due à un début de cataracte b. Se voit dans les cataractes totales c. Se corrige par le laser d. Est due un allongement de l'axe antéro-postérieur du globe oculaire.",
               "corrected_response": "a. Est due à un début de cataracte. c. Se corrige par le laser."
            },
                        {
                "question": "La cataracte intumescente ? a. Est une cataracte congénitale. b. Est une cataracte en rosace. c. Elle peut se compliquer d'un décollement de rétine. d. Elle peut se compliquer d'une crise de glaucome par fermeture de l'angle secondaire. e. Elle est due à l'augmentation du volume du cristallin.",
               "corrected_response": "a. Est une cataracte congénitale. b. Est une cataracte en rosace. c. Elle peut se compliquer d'un décollement de rétine."
            }
            ],
     "General Ophthalmology QCM": [

         {
             "question": "Le décollement de rétine rhegmatogène ? a. Survient volontiers chez le myope. b. Est précédé d’une déchirure rétinienne. c. Se traduit par une amputation du champ visuel. d. Doit être opéré en urgence. e. Se traduit par une baisse d’acuité visuelle.",
              "corrected_response": "a. Survient volontiers chez le myope. b. Est précédé d’une déchirure rétinienne. c. Se traduit par une amputation du champ visuel. d. Doit être opéré en urgence. e. Se traduit par une baisse d’acuité visuelle."
        }  ,
        {
             "question": "Le syndrome de Claude Bernard-Horner est en rapport avec ? a. Un myosis. b. Une énophtalmie. c. Un ptosis. d. Une exophtalmie. e. Une paralysie du III.",
             "corrected_response": "a. Un myosis. b. Une énophtalmie. c. Un ptosis."
        },
           {
             "question": "Concernant le strabisme paralytique ? a. L'un des signes est la limitation de la motilité oculaire. b. Peut s'accompagner de céphalées. c. La diplopie est monoculaire. d. La déviation peut se majorer dans le regard dans le sens de la paralysie. e. Toutes les réponses sont justes.",
             "corrected_response": "a. L'un des signes est la limitation de la motilité oculaire. b. Peut s'accompagner de céphalées. d. La déviation peut se majorer dans le regard dans le sens de la paralysie."
        },
         {
             "question": "Le diagnostic de paralysie du III se fait sur les signes suivants, sauf un, lequel ? a. Strabisme divergent. b. Mydriase. c. Ptosis. d. Limitation de l’élévation et de l’abaissement de l’œil. e. Limitation de l’adduction de l’œil.",
             "corrected_response": "d. Limitation de l’élévation et de l’abaissement de l’œil."
        },
          {
             "question": "Concernant les paralysies oculomotrices ? a. Une diplopie binoculaire traduit souvent une paralysie oculomotrice. b. Une diplopie monoculaire traduit souvent une paralysie oculomotrice. c. Peuvent être révélatrices d’une maladie neurologique. d. Peuvent être révélatrices d’une maladie générale. e. Se manifestent par un ptosis.",
             "corrected_response": "a. Une diplopie binoculaire traduit souvent une paralysie oculomotrice. c. Peuvent être révélatrices d’une maladie neurologique. d. Peuvent être révélatrices d’une maladie générale."
        },

         {
             "question": "Un œil rouge, douloureux et dur peut faire suspecter une crise de glaucome aigu ou une uvéite antérieure hypertensive aiguë. Parmi les signes suivants, quel est celui qui permet de retenir sans hésitation le premier diagnostic ? a. L'œdème cornéen. b. La baisse de vision. c. La mydriase. d. La photophobie. e. Le larmoiement.",
             "corrected_response": "c. La mydriase."
        },
           {
             "question": "Les étiologies responsables de cercle péri kératiques sont ? a. Le glaucome aigu. b. La conjonctivite. c. L'hémorragie sous conjonctivale. d. La kératite. e. L'uvéite antérieure.",
             "corrected_response": "a. Le glaucome aigu. d. La kératite. e. L'uvéite antérieure."
        },

           {
             "question": "Question: Recovery in cataract surgery is fastest with which of the following - Options: A. ICCE B. ECCE C. Phacoemulsification D. ECCE with ICI",
             "corrected_response": "OPTION C IS CORRECT"
        },
          {
          "question": "Question: Which of the following drug is not used in glaucoma: Options: A. Pilicarpine. B. Physostigmine. C. Metoprolol. D. Timolol.",
          "corrected_response": "OPTION C IS CORRECT."},
        {
            "question":"Question: True about incontinenta pigmenti include the following except: Options: A. X-linked dominant B. Primary skin abnormality C. Avascularity of peripheral retina D. Ocular involvement is seen in almost 100% cases and is typically unilateral",
             "corrected_response": "OPTION D IS CORRECT. "
        }

   ],
    "Clinical Cases QCM": [

        {
            "question": "Question: A 32-year-old woman presents to the emergency department due to severe, intractable headaches, and bilateral ocular pain. Her symptoms began approximately 2 weeks prior to presentation and have progressively worsened. She initially had right-sided headaches that were sharp, interfered with sleep, and were unresponsive to pain medications. The headache was around her right eye and cheek, and she noticed diplopia with right lateral gaze. Her symptoms were accompanied by fatigue, fever, and edema around the right eye. Approximately 2 days after these symptoms, she developed swelling around the left eye. Medical history is significant for a recent rhinosinusitis infection. Her temperature is 101°F (38.3°C), blood pressure is 133/72 mmHg, pulse is 90/min, and respirations are 18/min. On physical exam, there is ptosis, proptosis, chemosis, and periorbital swelling of both eyes. There is hyperesthesia in the bilateral ophthalmic and maxillary divisions of the trigeminal nerve. Fundoscopic exam demonstrates bilateral papilledema. There is mydriasis and eye muscle weakness in all directions. Which of the following is the most likely diagnosis? Options: A. Acute angle-closure glaucoma B. Bacterial endophthalmitis C. Cavernous sinus thrombosis D. Orbital cellulitis",
            "corrected_response": "OPTION C IS CORRECT."},
        {
            "question": "Question: A 30-year-old man returns to the hospital 3 weeks after open reduction and internal fixation of left tibia and fibula fractures from a motor vehicle accident. The patient complains that his surgical site has been draining pus for a few days, and his visiting nurse told him to go to the emergency room after he had a fever this morning. On exam, his temperature is 103.0°F (39.4°C), blood pressure is 85/50 mmHg, pulse is 115/min, and respirations are 14/min. The ED physician further documents that the patient is also starting to develop a diffuse, macular rash. The patient is started on broad spectrum antibiotics, and Gram stain demonstrates purple cocci in clusters. Which of the following toxins is likely to be the cause of this patient's condition? Options: A. Alpha toxin B. Endotoxin C. Pyogenic exotoxin A D. Toxic shock syndrome toxin 1",
            "corrected_response": "OPTION D IS CORRECT."},
         {
            "question": "Question: A patient presented with scarring alopecia, thinned nails, hypopigmented macular lesions over the trunk and oral mucosa. The diagnosis is – Options: A. Psoriasis B. Leprosy C. Lichen planus D. None",
            "corrected_response": "OPTION D IS CORRECT."},
          {
            "question": "Question: A 7-year-old girl presents to a new pediatrician with fever, shortness of breath, and productive cough. She had similar symptoms a few weeks ago. The girl was born at 39 weeks gestation via spontaneous vaginal delivery. She is up to date on all vaccines and is meeting all developmental milestones. A further review of her history reveals seizures, upper respiratory infections, and cellulitis. On physical examination, the patient is pale with white-blonde hair and pale blue eyes. Which of the following would you expect to see on a peripheral blood smear for this patient? Options: A. Predominance of band leukocytes B. Downey cells C. Polymorphonuclear leukocytes containing giant inclusion bodies D. Significant basophil predominance",
            "corrected_response": "OPTION C IS CORRECT."}
           ,
           {
            "question": "Question: A 71-year-old woman comes to the office with a history of headaches, fatigue, and weight loss for 3 months. The headaches are new for her, and usually not very severe. Her jaw also hurts when she is chewing food. Two days prior, she had briefly lost partial vision in her left eye. There were no other neurologic symptoms at the time. On examination, her neck is supple to flexion, fundi and neurologic examinations are normal. She is started on prednisone 60 mg/day and a biopsy is performed to confirm the diagnosis. Which of the following is the most likely change seen on the biopsy to confirm the diagnosis? Options: A. immune complex deposition B. arteritis with giant cells C. lymphocytic infiltration D. type II muscle fiber atrophy",
            "corrected_response": "OPTION B IS CORRECT."
              },
          {
            "question": "Question: A previously healthy 10-year-old girl is brought to the physician because of severe malaise, pink eyes, cough, and a runny nose for 3 days. She recently immigrated from Sudan and immunization records are unavailable. Her temperature is 40.1°C (104.1°F). Examination shows bilateral conjunctival injections. There are multiple bluish-gray lesions on an erythematous buccal mucosa and soft palate. This patient is at increased risk for which of the following complications? Options: A. Immune thrombocytopenic purpura B. Subacute sclerosing panencephalitis C. Transient arrest of erythropoiesis D. Glomerular immune complex deposition",
            "corrected_response": "OPTION B IS CORRECT."

           },
        {
  "question": "Question: A 47-year-old woman is brought to the hospital by her husband with fever, headache, confusion, and jaundice for 1 week. She underwent a hysterectomy 2 months ago and began estrogen replacement therapy recently. On admission, her temperature is 38.7 C (102 F), blood pressure is 140/90 mm Hg, Pulse is 98/min, and Respiratory rate is 20/min. She appears disoriented to time and place. Physical examination reveals jaundiced sclerae and skin, purpura on the trunk, and bleeding gums. Her platelet count is 25,000/mm3, hematocrit is 24%, and creatinine is 4.9 mg/dL. Lactate dehydrogenase (LDH) and indirect bilirubin are elevated. Coagulation tests are within normal limits, but the bleeding time is increased; fibrin-split products and Coombs test are negative. A peripheral blood smear shows schistocytes, helmet-shaped cells, and cells with a triangular shape. Which of the following is the most likely diagnosis? Options: A. Autoimmune hemolytic anemia B. Disseminated intravascular coagulation (DIC) C. Hemolytic-uremic syndrome (HUS) D. Thrombotic thrombocytopenic purpura (TTP)",
  "corrected_response": "Option D: Thrombotic thrombocytopenic purpura (TTP) is the most likely diagnosis. It presents with microangiopathic hemolytic anemia, increased bleeding time, decreased platelet count, elevated indirect bilirubin and LDH, and characteristic findings on blood smear like schistocytes and helmet-shaped cells.",

},{
      "question": "Question: A 50-year-old man came to the ophthalmologist with the complaint of inability to read newspaper. His vision problem is likely due to inadequate contraction of which of the following structures? Options: A. Ciliary body B. Dilator pupillae C. Extraocular muscles D. Suspensory ligaments of lens",
     "corrected_response": "OPTION A IS CORRECT.",

},{
      "question": "Question: A 57-year-old man presents to the emergency department because he has been having abdominal pain for the past several months. Specifically, he complains of severe epigastric pain after eating that is sometimes accompanied by diarrhea. He has also lost 20 pounds over the same time period, which he attributes to the fact that the pain has been stopping him from wanting to eat. He does not recall any changes to his urine or stool. Physical exam reveals scleral icterus and a large non-tender gallbladder. Which of the following substances would most likely be elevated in the serum of this patient? Options: A. Alpha-fetoprotein B. CA-19-9 C. CEA D. PTHrP",
     "corrected_response": "OPTION B IS CORRECT.",

},
        {
            "question": "Question: A 6-month-old boy is brought to the emergency department by his mother because of recurrent vomiting and yellowing of his eyes. The mother says that he has been eating poorly since she started weaning him off of breast milk 5 days ago. At this time, mashed vegetables and fruits were added to his diet. Examination shows scleral jaundice and dry mucous membranes. The tip of the liver is palpable 4 cm below the right costal margin. His serum glucose concentration is 47 mg/dL, serum alanine aminotransferase is 55 U/L, and serum aspartate aminotransferase is 66 U/L. Which of the following enzymes is most likely deficient? Options: A. Galactokinase B. Galactose-1 phosphate uridyltransferase C. Aldolase B D. Glucose-6-phosphatase",
            "corrected_response": "OPTION C IS CORRECT."},

]


}
# Function to extract the response from the model's output
def extract_response(model_output):
    # Find the text after [/INST]
    split_text = model_output.split('[/INST]')
    if len(split_text) > 1:
        return split_text[1].strip()
    return model_output

# Function to evaluate the model's response
def evaluate_response(model_response, corrected_response):
    if model_response.strip() == corrected_response.strip():
        return "complet"
    elif corrected_response.strip() in model_response.strip():
        return "incomplet"
    else:
        return "incorrect"

# Generate random data for the CSV
def generate_csv_data(filename, num_rows=100):
    with open(filename, mode='w', newline='', encoding='utf-8') as file:
        writer = csv.writer(file)
        writer.writerow(columns)  # Write the header

        for _ in range(num_rows):
            timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            question_type = random.choice(question_types)
            question_entry = random.choice(sample_questions[question_type])
            question = question_entry["question"]
            corrected_response = question_entry["corrected_response"]

            # Measure time for model response
            start_time = time.time()
            model_output = model_pipeline(f"<s>[INST] {question} [/INST]", max_new_tokens=250, num_return_sequences=1)[0]['generated_text']
            end_time = time.time()
            response_time = end_time - start_time  # Calculate response time

            # Extract the model's response
            model_response = extract_response(model_output)

            # Evaluate the model's response
            evaluation = evaluate_response(model_response, corrected_response)

            writer.writerow([
                timestamp, model_name, question_type, question, corrected_response,
                evaluation, model_response, response_time
            ])

# Calculate the number of rows based on the number of QCM questions in each category
num_rows_per_category = sum(len(questions) for questions in sample_questions.values())

# Generate the CSV data
csv_filename = 'llama_evaluation.csv'
generate_csv_data(csv_filename, num_rows=num_rows_per_category)

# Provide a download link for the CSV file
from google.colab import files
files.download(csv_filename)

"""---

===> We dindn't used because we evaluate later manualy

---

### Model Evalution Manualy

---
"""

import time
from transformers import pipeline

# Load the model
model_name = "abirT/Llama-2-7B-finetuning-ophtalmology"
model_pipeline = pipeline("text-generation", model=model_name)

# Function to extract the response after [/INST]
def extract_model_response(full_response):
    response_start = full_response.find('[/INST]') + len('[/INST]')
    extracted_response = full_response[response_start:].strip()
    return extracted_response

# Function to get the model's response for a given question
def get_model_response(question):
    start_time = time.time()
    full_model_response = model_pipeline(f"<s>[INST] {question} [/INST]", max_new_tokens=250, num_return_sequences=1)[0]['generated_text']
    end_time = time.time()
    response_time = end_time - start_time
    model_response = extract_model_response(full_model_response)
    return model_response, full_model_response, response_time

# List to store traceability of inputs and outputs
traceability = []

# Manually enter questions and get model responses
while True:
    question = input("Enter your question (or type 'exit' to quit): ")
    if question.lower() == 'exit':
        break
    model_response, full_model_response, response_time = get_model_response(question)
    traceability.append({'question': question, 'full_response': full_model_response, 'extracted_response': model_response, 'response_time': response_time})
    print(f"Model Response: {model_response}")
    print(f"Response Time: {response_time:.2f} seconds")

# Display all traceability records
print("\nTraceability Records:")
for record in traceability:
    print(f"Question: {record['question']}")
    print(f"Full Response: {record['full_response']}")
    print(f"Extracted Response: {record['extracted_response']}")
    print(f"Response Time: {record['response_time']:.2f} seconds")
    print("\n")

# Manually enter questions and get model responses
while True:
    question = input("Enter your question (or type 'exit' to quit): ")
    if question.lower() == 'exit':
        break
    model_response, full_model_response, response_time = get_model_response(question)
    traceability.append({'question': question, 'full_response': full_model_response, 'extracted_response': model_response, 'response_time': response_time})
    print(f"Model Response: {model_response}")
    print(f"Response Time: {response_time:.2f} seconds")

# Display all traceability records
print("\nTraceability Records:")
for record in traceability:
    print(f"Question: {record['question']}")
    print(f"Full Response: {record['full_response']}")
    print(f"Extracted Response: {record['extracted_response']}")
    print(f"Response Time: {record['response_time']:.2f} seconds")
    print("\n")

"""

---


### **Final Evaluation Generator Script**


---


"""

import csv
import datetime
import random
import pandas as pd
from transformers import (
    AutoModelForCausalLM,
    AutoTokenizer,
    pipeline
)
import time

# Define the columns for the CSV file
columns = ["Timestamp",
           "Question Type",
           "Question",
           "Corrected Response",
           "Evaluation",
           "Response Time (s)"]

# Define the types of questions and possible responses
question_types = [
    "Ocular Anatomy QCM",
    "Ocular Pathology QCM",
    "General Ophthalmology QCM",
    "Clinical Cases QCM"
]

# questions and corrected responses
sample_questions = {
    "Ocular Anatomy QCM": [
        {
            "question": "La rétine ? a. Est un tissu neurosensoriel. b. Est composée de 5 couches. c. Au centre se trouve la macula comportant une forte concentration en bâtonnets et responsable de l’acuité visuelle maximale. d. Constituée de photorécepteurs de sorte que les cônes périphériques assurent la vision diurne et les cônes centraux la vision nocturne. e. Toutes les réponses sont fausses.",
            "corrected_response": "a. Est un tissu neurosensoriel."
        },
        {
            "question": "Le cristallin ? a. Est une lentille biconcave richement vascularisée. b. Il est responsable de l'accommodation. c. Sa caractéristique principale est la transparence. d. Est localisé entre l'iris et la chambre postérieure en avant et la rétine en arrière. e. Est suspendu au corps ciliaire par la zonule de ZINN.",
            "corrected_response": "a. Est une lentille biconcave richement vascularisée. d. Est localisé entre l'iris et la chambre postérieure en avant et la rétine en arrière."
        },
          {
            "question": "Les muscles oculomoteurs ? a. Assurent la motilité du globe oculaire. b. Le III innerve le droit externe. c. Le VI innerve le sphincter irien. d. Le III innerve l'oblique supérieure. e. Le IV innerve l'oblique inférieure",
            "corrected_response": "a. Assurent la motilité du globe oculaire."
        },
        {
            "question": "La longueur axiale ? a. Est la distance entre le sommet de la cornée et la rétine. b. La distance entre la cornée et le cristallin. c. Mesure entre 22 et 24 mm. d. Plus élevée chez le myope. e. Plus courte en cas d'astigmatisme.",
            "corrected_response": "a. Est la distance entre le sommet de la cornée et la rétine. c. Mesure entre 22 et 24 mm. d. Plus élevée chez le myope."
            },
         {
            "question": "La cornée ? a. Assure 1 / 3 du pouvoir réfractif du globe oculaire. b. Le test à la fluorescéine permet de rechercher une atteinte de l’endothélium cornéen. c. Le port de lentilles de contact est le principal facteur de risque des infections de la cornée. d. Les collyres corticoïdes retardent la cicatrisation de l'épithélium cornéen. e. Dans les brûlures chimiques, les acides pénètrent très rapidement dans le stroma cornéen.",
            "corrected_response": "c. Le port de lentilles de contact est le principal facteur de risque des infections de la cornée. d. Les collyres corticoïdes retardent la cicatrisation de l'épithélium cornéen." },
         {
            "question": "La microscopie spéculaire ? a. Elle permet le calcul du rayon de courbure de la cornée. b. Elle permet le calcul de la longueur axiale. c. Elle permet le calcul du comptage des cellules endothéliales cornéennes. d. Elle permet l'exploration du segment postérieur de l'œil. e. Elle permet une coupe presque histologique de la rétine.",
            "corrected_response": "c. Elle permet le calcul du comptage des cellules endothéliales cornéennes."
             },
         {
            "question": "Concernant les voies lacrymales ? a. L'imperméabilité des voies lacrymales peut donner un larmoiement. b. Une sténose des voies lacrymales nécessite parfois une intervention chirurgicale. c. L'imperméabilité des voies lacrymales se diagnostique par un test au bleu de méthylène. d. L'imperméabilité des voies lacrymales peut donner une kératite. e. Un larmoiement chronique impose un bilan ophtalmologique.",
            "corrected_response": "a. L'imperméabilité des voies lacrymales peut donner un larmoiement. b. Une sténose des voies lacrymales nécessite parfois une intervention chirurgicale. d. L'imperméabilité des voies lacrymales peut donner une kératite. e. Un larmoiement chronique impose un bilan ophtalmologique." }
             ,
           {
            "question": "Question: Diameter of the macula lutea is: Options: A. 1.5 mm B. 3.5 mm C. 4.5 mm D. 5.5 mm",
            "corrected_response": "OPTION D IS CORRECT."
             },
         {
            "question": "Question: Corneal endothelium is embryologically derived from Options: A. Neural crest B. Ectoderm C. Mesoderm D. Endoderm",
            "corrected_response": "OPTION A IS CORRECT."
             },
        {
            "question":" Question: Lamina cribrosa is not present in Options: A. Morning glory syndrome B. Nanophthalmia C. Coloboma of retina D. Optic nerve agenesis",
            "corrected_response": "Morning glory syndrome is a mesodermal defect in which there is peripapillary defect along with absence of lamina cribrosa. OPTION A IS CORRECT."
        }




   ],
    "Ocular Pathology QCM": [


             {
                "question": "L'héméralopie est liée à ? a. La cataracte. b. Un diabète. c. La rétinite pigmentaire. d. Un décollement de rétine. e. La DMLA.",
                "corrected_response": "c. La rétinite pigmentaire." },
            {
                "question": "Une hémorragie intravitréenne peut être due à ? a. Une rétinopathie diabétique proliférative. b. Un traumatisme. c. Un décollement de rétine. d. Une occlusion de la veine centrale de la rétine. e. Une DMLA.",
                "corrected_response": "a. Une rétinopathie diabétique proliférative. b. Un traumatisme. c. Un décollement de rétine. d. Une occlusion de la veine centrale de la rétine." },

              {
                "question": "L'œdème de Berlin constitue une contusion du segment postérieur qui ? a. Se traduit par un niveau liquide hématique dans la chambre antérieure dont le risque est la récidive hémorragique. b. Apparaît sous la forme d'une hémorragie conjonctivale probablement due à une plaie sclérale sous-jacente ou un corps étranger. c. Évolue vers la résorption spontanée en tant qu'hémorragie intra-vitréenne empêchant la visualisation de la rétine. d. Est responsable d'une baisse d'acuité visuelle initiale souvent transitoire. e. Peut évoluer parfois vers la constitution d'un trou maculaire avec une baisse d'acuité visuelle définitive.",
                "corrected_response": "c. Sclérite." },
             {
                "question": "La rétinopathie diabétique ? a. C'est la manifestation de la micro-angiopathie diabétique. b. C'est la manifestation de la macroangiopathie diabétique. c. C'est l'affection vasculaire rétinienne la plus fréquente. d. Elle est toujours bilatérale. e. Elle survient uniquement chez le diabétique type 1.",
                "corrected_response": "a. C'est la manifestation de la micro-angiopathie diabétique. c. C'est l'affection vasculaire rétinienne la plus fréquente. d. Elle est toujours bilatérale." },
    {
               "question": " Question: A 26-year-old woman with multiple sclerosis comes to the physician because of a recent relapse Examination of the eye movements shows slow adduction of the left eye with an associated right-beating nystagmus in the right eye. Which of the following is the location of the pathology that underlies this abnormality? Options: A. Abducens nerve palsy B. Left medial longitudinal fasciculus C. Right medial longitudinal fasciculus D. Right oculomotor nerve",
               "corrected_response": "OPTION B IS CORRECT."
           },
            {
             "question": "Question: Homonymous hemianopia with usually sparing of the macula is seen in lesions of: Options: A. Geniculate body B. Optic radiations C. Visual coex D. All of the above",
             "corrected_response": "Ans. Visual coex OPTION C IS CORRECT.",
             }
           ,
             {
             "question": "Question: First sign of optic nerve disease is- Options: A. Papilloedema B. Colour blindness C. Afferent pupillary defect D. Efferent pupillary defect",
             "corrected_response": "Marcuss Gunn pupil or RAPD (relative afferent papillary defect) is the earliest indication of optic nerve disease even in presence of normal visual acuity. OPTION C IS CORRECT.",
             }
           ,

             {
             "question": "Question: Cataracts in a newborn is: Options: A. Zonular B. Nuclear C. Snowflake D. Cortical",
             "corrected_response": "a zonular refkhurana 3rd/e p. 187 OPTION A IS CORRECT.",
             },
            {
                "question": "La myopie d'indice est ? a. Est due à un début de cataracte b. Se voit dans les cataractes totales c. Se corrige par le laser d. Est due un allongement de l'axe antéro-postérieur du globe oculaire.",
               "corrected_response": "a. Est due à un début de cataracte. c. Se corrige par le laser."
            },
                        {
                "question": "La cataracte intumescente ? a. Est une cataracte congénitale. b. Est une cataracte en rosace. c. Elle peut se compliquer d'un décollement de rétine. d. Elle peut se compliquer d'une crise de glaucome par fermeture de l'angle secondaire. e. Elle est due à l'augmentation du volume du cristallin.",
               "corrected_response": "a. Est une cataracte congénitale. b. Est une cataracte en rosace. c. Elle peut se compliquer d'un décollement de rétine."
            }
            ],
     "General Ophthalmology QCM": [

         {
             "question": "Le décollement de rétine rhegmatogène ? a. Survient volontiers chez le myope. b. Est précédé d’une déchirure rétinienne. c. Se traduit par une amputation du champ visuel. d. Doit être opéré en urgence. e. Se traduit par une baisse d’acuité visuelle.",
              "corrected_response": "a. Survient volontiers chez le myope. b. Est précédé d’une déchirure rétinienne. c. Se traduit par une amputation du champ visuel. d. Doit être opéré en urgence. e. Se traduit par une baisse d’acuité visuelle."
        }  ,
        {
             "question": "Le syndrome de Claude Bernard-Horner est en rapport avec ? a. Un myosis. b. Une énophtalmie. c. Un ptosis. d. Une exophtalmie. e. Une paralysie du III.",
             "corrected_response": "a. Un myosis. b. Une énophtalmie. c. Un ptosis."
        },
           {
             "question": "Concernant le strabisme paralytique ? a. L'un des signes est la limitation de la motilité oculaire. b. Peut s'accompagner de céphalées. c. La diplopie est monoculaire. d. La déviation peut se majorer dans le regard dans le sens de la paralysie. e. Toutes les réponses sont justes.",
             "corrected_response": "a. L'un des signes est la limitation de la motilité oculaire. b. Peut s'accompagner de céphalées. d. La déviation peut se majorer dans le regard dans le sens de la paralysie."
        },
         {
             "question": "Le diagnostic de paralysie du III se fait sur les signes suivants, sauf un, lequel ? a. Strabisme divergent. b. Mydriase. c. Ptosis. d. Limitation de l’élévation et de l’abaissement de l’œil. e. Limitation de l’adduction de l’œil.",
             "corrected_response": "d. Limitation de l’élévation et de l’abaissement de l’œil."
        },
          {
             "question": "Concernant les paralysies oculomotrices ? a. Une diplopie binoculaire traduit souvent une paralysie oculomotrice. b. Une diplopie monoculaire traduit souvent une paralysie oculomotrice. c. Peuvent être révélatrices d’une maladie neurologique. d. Peuvent être révélatrices d’une maladie générale. e. Se manifestent par un ptosis.",
             "corrected_response": "a. Une diplopie binoculaire traduit souvent une paralysie oculomotrice. c. Peuvent être révélatrices d’une maladie neurologique. d. Peuvent être révélatrices d’une maladie générale."
        },

         {
             "question": "Un œil rouge, douloureux et dur peut faire suspecter une crise de glaucome aigu ou une uvéite antérieure hypertensive aiguë. Parmi les signes suivants, quel est celui qui permet de retenir sans hésitation le premier diagnostic ? a. L'œdème cornéen. b. La baisse de vision. c. La mydriase. d. La photophobie. e. Le larmoiement.",
             "corrected_response": "c. La mydriase."
        },
           {
             "question": "Les étiologies responsables de cercle péri kératiques sont ? a. Le glaucome aigu. b. La conjonctivite. c. L'hémorragie sous conjonctivale. d. La kératite. e. L'uvéite antérieure.",
             "corrected_response": "a. Le glaucome aigu. d. La kératite. e. L'uvéite antérieure."
        },

           {
             "question": "Question: Recovery in cataract surgery is fastest with which of the following - Options: A. ICCE B. ECCE C. Phacoemulsification D. ECCE with ICI",
             "corrected_response": "OPTION C IS CORRECT"
        },
          {
          "question": "Question: Which of the following drug is not used in glaucoma: Options: A. Pilicarpine. B. Physostigmine. C. Metoprolol. D. Timolol.",
          "corrected_response": "OPTION C IS CORRECT."},
        {
            "question":"Question: True about incontinenta pigmenti include the following except: Options: A. X-linked dominant B. Primary skin abnormality C. Avascularity of peripheral retina D. Ocular involvement is seen in almost 100% cases and is typically unilateral",
             "corrected_response": "OPTION D IS CORRECT. "
        }

   ],
    "Clinical Cases QCM": [

        {
            "question": "Question: A 32-year-old woman presents to the emergency department due to severe, intractable headaches, and bilateral ocular pain. Her symptoms began approximately 2 weeks prior to presentation and have progressively worsened. She initially had right-sided headaches that were sharp, interfered with sleep, and were unresponsive to pain medications. The headache was around her right eye and cheek, and she noticed diplopia with right lateral gaze. Her symptoms were accompanied by fatigue, fever, and edema around the right eye. Approximately 2 days after these symptoms, she developed swelling around the left eye. Medical history is significant for a recent rhinosinusitis infection. Her temperature is 101°F (38.3°C), blood pressure is 133/72 mmHg, pulse is 90/min, and respirations are 18/min. On physical exam, there is ptosis, proptosis, chemosis, and periorbital swelling of both eyes. There is hyperesthesia in the bilateral ophthalmic and maxillary divisions of the trigeminal nerve. Fundoscopic exam demonstrates bilateral papilledema. There is mydriasis and eye muscle weakness in all directions. Which of the following is the most likely diagnosis? Options: A. Acute angle-closure glaucoma B. Bacterial endophthalmitis C. Cavernous sinus thrombosis D. Orbital cellulitis",
            "corrected_response": "OPTION C IS CORRECT."},
        {
            "question": "Question: A 30-year-old man returns to the hospital 3 weeks after open reduction and internal fixation of left tibia and fibula fractures from a motor vehicle accident. The patient complains that his surgical site has been draining pus for a few days, and his visiting nurse told him to go to the emergency room after he had a fever this morning. On exam, his temperature is 103.0°F (39.4°C), blood pressure is 85/50 mmHg, pulse is 115/min, and respirations are 14/min. The ED physician further documents that the patient is also starting to develop a diffuse, macular rash. The patient is started on broad spectrum antibiotics, and Gram stain demonstrates purple cocci in clusters. Which of the following toxins is likely to be the cause of this patient's condition? Options: A. Alpha toxin B. Endotoxin C. Pyogenic exotoxin A D. Toxic shock syndrome toxin 1",
            "corrected_response": "OPTION D IS CORRECT."},
         {
            "question": "Question: A patient presented with scarring alopecia, thinned nails, hypopigmiented macular lesions over the trunk and oral mucosa. The diagnosis is – Options: A. Psoriasis B. Leprosy C. Lichen planus D. None",
            "corrected_response": "OPTION D IS CORRECT."},
          {
            "question": "Question: A 7-year-old girl presents to a new pediatrician with fever, shortness of breath, and productive cough. She had similar symptoms a few weeks ago. The girl was born at 39 weeks gestation via spontaneous vaginal delivery. She is up to date on all vaccines and is meeting all developmental milestones. A further review of her history reveals seizures, upper respiratory infections, and cellulitis. On physical examination, the patient is pale with white-blonde hair and pale blue eyes. Which of the following would you expect to see on a peripheral blood smear for this patient? Options: A. Predominance of band leukocytes B. Downey cells C. Polymorphonuclear leukocytes containing giant inclusion bodies D. Significant basophil predominance",
            "corrected_response": "OPTION C IS CORRECT."}
           ,
           {
            "question": "Question: A 71-year-old woman comes to the office with a history of headaches, fatigue, and weight loss for 3 months. The headaches are new for her, and usually not very severe. Her jaw also hurts when she is chewing food. Two days prior, she had briefly lost partial vision in her left eye. There were no other neurologic symptoms at the time. On examination, her neck is supple to flexion, fundi and neurologic examinations are normal. She is started on prednisone 60 mg/day and a biopsy is performed to confirm the diagnosis. Which of the following is the most likely change seen on the biopsy to confirm the diagnosis? Options: A. immune complex deposition B. arteritis with giant cells C. lymphocytic infiltration D. type II muscle fiber atrophy",
            "corrected_response": "OPTION B IS CORRECT."
              },
          {
            "question": "Question: A previously healthy 10-year-old girl is brought to the physician because of severe malaise, pink eyes, cough, and a runny nose for 3 days. She recently immigrated from Sudan and immunization records are unavailable. Her temperature is 40.1°C (104.1°F). Examination shows bilateral conjunctival injections. There are multiple bluish-gray lesions on an erythematous buccal mucosa and soft palate. This patient is at increased risk for which of the following complications? Options: A. Immune thrombocytopenic purpura B. Subacute sclerosing panencephalitis C. Transient arrest of erythropoiesis D. Glomerular immune complex deposition",
            "corrected_response": "OPTION B IS CORRECT."

           },
        {
  "question": "Question: A 47-year-old woman is brought to the hospital by her husband with fever, headache, confusion, and jaundice for 1 week. She underwent a hysterectomy 2 months ago and began estrogen replacement therapy recently. On admission, her temperature is 38.7 C (102 F), blood pressure is 140/90 mm Hg, Pulse is 98/min, and Respiratory rate is 20/min. She appears disoriented to time and place. Physical examination reveals jaundiced sclerae and skin, purpura on the trunk, and bleeding gums. Her platelet count is 25,000/mm3, hematocrit is 24%, and creatinine is 4.9 mg/dL. Lactate dehydrogenase (LDH) and indirect bilirubin are elevated. Coagulation tests are within normal limits, but the bleeding time is increased; fibrin-split products and Coombs test are negative. A peripheral blood smear shows schistocytes, helmet-shaped cells, and cells with a triangular shape. Which of the following is the most likely diagnosis? Options: A. Autoimmune hemolytic anemia B. Disseminated intravascular coagulation (DIC) C. Hemolytic-uremic syndrome (HUS) D. Thrombotic thrombocytopenic purpura (TTP)",
  "corrected_response": "Option D: Thrombotic thrombocytopenic purpura (TTP) is the most likely diagnosis. It presents with microangiopathic hemolytic anemia, increased bleeding time, decreased platelet count, elevated indirect bilirubin and LDH, and characteristic findings on blood smear like schistocytes and helmet-shaped cells.",

},{
      "question": "Question: A 50-year-old man came to the ophthalmologist with the complaint of inability to read newspaper. His vision problem is likely due to inadequate contraction of which of the following structures? Options: A. Ciliary body B. Dilator pupillae C. Extraocular muscles D. Suspensory ligaments of lens",
     "corrected_response": "OPTION A IS CORRECT.",

},{
      "question": "Question: A 57-year-old man presents to the emergency department because he has been having abdominal pain for the past several months. Specifically, he complains of severe epigastric pain after eating that is sometimes accompanied by diarrhea. He has also lost 20 pounds over the same time period, which he attributes to the fact that the pain has been stopping him from wanting to eat. He does not recall any changes to his urine or stool. Physical exam reveals scleral icterus and a large non-tender gallbladder. Which of the following substances would most likely be elevated in the serum of this patient? Options: A. Alpha-fetoprotein B. CA-19-9 C. CEA D. PTHrP",
     "corrected_response": "OPTION B IS CORRECT.",

},
        {
            "question": "Question: A 6-month-old boy is brought to the emergency department by his mother because of recurrent vomiting and yellowing of his eyes. The mother says that he has been eating poorly since she started weaning him off of breast milk 5 days ago. At this time, mashed vegetables and fruits were added to his diet. Examination shows scleral jaundice and dry mucous membranes. The tip of the liver is palpable 4 cm below the right costal margin. His serum glucose concentration is 47 mg/dL, serum alanine aminotransferase is 55 U/L, and serum aspartate aminotransferase is 66 U/L. Which of the following enzymes is most likely deficient? Options: A. Galactokinase B. Galactose-1 phosphate uridyltransferase C. Aldolase B D. Glucose-6-phosphatase",
            "corrected_response": "OPTION C IS CORRECT."},

]


}

# Function to generate CSV data
def generate_csv_data(filename, questions):
    with open(filename, mode='w', newline='', encoding='utf-8') as file:
        writer = csv.writer(file)
        writer.writerow(columns)  # Write the header
        data = []
        for question_type, questions_list in questions.items():
            for question_entry in questions_list:
                timestamp = pd.Timestamp.now().strftime("%Y-%m-%d %H:%M:%S")
                question = question_entry["question"]
                corrected_response = question_entry["corrected_response"]
                # Manually input the evaluation and response time
              evaluation = input(f"Enter evaluation for the question '{question}': ")
                response_time = input(f"Enter response time (in seconds) for the question '{question}': ")

                row = [
                    timestamp, question_type, question, corrected_response,
                    evaluation, response_time
                ]
                data.append(row)
                writer.writerow(row)

    return data

# Generate the CSV file
csv_filename = 'llm_evaluation_data.csv'
data = generate_csv_data(csv_filename, sample_questions)

# Download the CSV file from Google Colab
from google.colab import files
files.download(csv_filename)

"""

---
### Test The model Inference parameters
---

Inference parameters are values that you can adjust to limit or influence the model response. The following categories of parameters are commonly found across different models.

* Temperature– Affects the shape of the probability distribution for the predicted output and influences the likelihood of the model selecting lower-probability outputs.

Choose a lower value to influence the model to select higher-probability outputs.

Choose a higher value to influence the model to select lower-probability outputs.

In technical terms, the temperature modulates the probability mass function for the next token. A lower temperature steepens the function and leads to more deterministic responses, and a higher temperature flattens the function and leads to more random responses.

* Top K – The number of most-likely candidates that the model considers for the next token.

Choose a lower value to decrease the size of the pool and limit the options to more likely outputs.

Choose a higher value to increase the size of the pool and allow the model to consider less likely outputs.

For example, if you choose a value of 50 for Top K, the model selects from 50 of the most probable tokens that could be next in the sequence.

* Top P – The percentage of most-likely candidates that the model considers for



the next token.

Choose a lower value to decrease the size of the pool and limit the options to more likely outputs.

Choose a higher value to increase the size of the pool and allow the model to consider less likely outputs.

In technical terms, the model computes the cumulative probability distribution for the set of responses and considers only the top P% of the distribution.

For example, if you choose a value of 0.8 for Top P, the model selects from the top 80% of the probability distribution of tokens that could be next in the sequence.

"""

import time
from transformers import pipeline

# Load the model
model_name = "abirT/Llama-2-7B-finetuning-ophtalmology"
model_pipeline = pipeline("text-generation", model=model_name)

# Function to extract the response after [/INST]
def extract_model_response(full_response):
    response_start = full_response.find('[/INST]') + len('[/INST]')
    extracted_response = full_response[response_start:].strip()
    return extracted_response

# Function to get the model's response for a given question
def get_model_response(question):
    start_time = time.time()
    full_model_response = model_pipeline(
        f"<s>[INST] {question} [/INST]",
        max_new_tokens=250,
        num_return_sequences=1,
        temperature=0.70,
        top_k=50,
        top_p=0.95
    )[0]['generated_text']
    end_time = time.time()
    response_time = end_time - start_time
    model_response = extract_model_response(full_model_response)
    return model_response, full_model_response, response_time

# List to store traceability of inputs and outputs
traceability = []

# Manually enter questions and get model responses
while True:
    question = input("Enter your question (or type 'exit' to quit): ")
    if question.lower() == 'exit':
        break
    model_response, full_model_response, response_time = get_model_response(question)
    traceability.append({
        'question': question,
        'full_response': full_model_response,
        'extracted_response': model_response,
        'response_time': response_time
    })
    print(f"Model Response: {model_response}")
    print(f"Response Time: {response_time:.2f} seconds")

# Display all traceability records
print("\nTraceability Records:")
for record in traceability:
    print(f"Question: {record['question']}")
    print(f"Full Response: {record['full_response']}")
    print(f"Extracted Response: {record['extracted_response']}")
    print(f"Response Time: {record['response_time']:.2f} seconds")
    print("\n")